<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attention-Guided RAG Explorer</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --void: #030308;
            --abyss: #08080f;
            --deep: #0c0c14;
            --surface: #12121c;
            --elevated: #1a1a28;
            --border: #252538;
            --border-glow: #3a3a55;

            --cyan: #00e5ff;
            --magenta: #ff0099;
            --lime: #b4ff00;
            --amber: #ffaa00;
            --violet: #aa00ff;
            --blue: #0088ff;

            --text: #e8e8f4;
            --text-dim: #707090;
            --text-muted: #50506a;

            /* Zone colors */
            --semantic-bridge: #00e5ff;
            --long-range: #aa00ff;
            --syntax-floor: #50506a;
            --diffuse: #ffaa00;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            font-family: 'IBM Plex Mono', monospace;
            background: var(--void);
            color: var(--text);
            min-height: 100vh;
        }

        /* Layout */
        .app {
            display: grid;
            grid-template-rows: 70px 1fr;
            min-height: 100vh;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            background: linear-gradient(180deg, var(--abyss) 0%, var(--void) 100%);
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--cyan), var(--magenta));
            border-radius: 12px;
            display: grid;
            place-items: center;
            font-weight: 800;
            font-size: 20px;
            color: var(--void);
        }

        .logo-text h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--text), var(--cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-text span {
            font-size: 11px;
            color: var(--text-dim);
            letter-spacing: 1px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .help-btn {
            padding: 8px 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-dim);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .help-btn:hover {
            border-color: var(--cyan);
            color: var(--cyan);
        }

        .server-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--surface);
            border-radius: 8px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-dot.connected { background: var(--lime); }
        .status-dot.error { background: var(--magenta); }

        /* Main Content */
        .main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            padding: 24px 32px;
            overflow: auto;
        }

        /* Cards */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: var(--elevated);
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-body {
            padding: 20px;
        }

        /* Info Icons & Tooltips */
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--border);
            color: var(--text-dim);
            font-size: 10px;
            cursor: help;
            transition: all 0.2s;
        }

        .info-icon:hover {
            background: var(--cyan);
            color: var(--void);
        }

        .tooltip-container {
            position: relative;
            display: inline-flex;
        }

        .tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 16px;
            background: var(--elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 11px;
            line-height: 1.5;
            color: var(--text);
            white-space: normal;
            width: 280px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--border);
        }

        .tooltip-container:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }

        .tooltip-title {
            font-weight: 600;
            color: var(--cyan);
            margin-bottom: 6px;
            display: block;
        }

        .tooltip-formula {
            font-family: 'IBM Plex Mono', monospace;
            background: var(--deep);
            padding: 6px 8px;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 10px;
            color: var(--lime);
        }

        /* Query Section */
        .query-input {
            width: 100%;
            background: var(--deep);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            color: var(--text);
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }

        .query-input:focus {
            outline: none;
            border-color: var(--cyan);
            box-shadow: 0 0 0 2px rgba(0, 229, 255, 0.1);
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--cyan), var(--blue));
            border: none;
            border-radius: 8px;
            color: var(--void);
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(0, 229, 255, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--elevated);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .query-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        /* Retrieval Need Meter */
        .retrieval-meter {
            margin-top: 20px;
            padding: 16px;
            background: var(--deep);
            border-radius: 8px;
        }

        .meter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .meter-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-dim);
        }

        .meter-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .meter-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--lime), var(--amber), var(--magenta));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .meter-scale {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            font-size: 9px;
            color: var(--text-muted);
        }

        .retrieval-decision {
            margin-top: 12px;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
        }

        .retrieval-decision.retrieve {
            background: rgba(0, 229, 255, 0.1);
            border: 1px solid var(--cyan);
            color: var(--cyan);
        }

        .retrieval-decision.skip {
            background: rgba(180, 255, 0, 0.1);
            border: 1px solid var(--lime);
            color: var(--lime);
        }

        /* Token Analysis */
        .token-analysis {
            margin-top: 20px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 12px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .token-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }

        .token {
            padding: 6px 10px;
            background: var(--deep);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.2s;
            cursor: help;
        }

        .token.anchor {
            background: rgba(0, 229, 255, 0.15);
            border-color: var(--cyan);
            color: var(--cyan);
        }

        .token.semantic-bridge {
            border-left: 3px solid var(--semantic-bridge);
        }

        .token.long-range {
            border-left: 3px solid var(--long-range);
        }

        .token.syntax-floor {
            border-left: 3px solid var(--syntax-floor);
        }

        /* Documents Section */
        .document-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .document-item {
            padding: 16px;
            background: var(--deep);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .document-item:hover {
            border-color: var(--border-glow);
        }

        .document-item.selected {
            border-color: var(--cyan);
            background: rgba(0, 229, 255, 0.05);
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .document-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-dim);
        }

        .document-score {
            font-size: 11px;
            padding: 4px 8px;
            background: var(--surface);
            border-radius: 4px;
        }

        .document-text {
            font-size: 13px;
            line-height: 1.5;
            color: var(--text);
        }

        .score-bars {
            margin-top: 12px;
        }

        .score-bar {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 6px;
        }

        .score-bar-label {
            font-size: 10px;
            color: var(--text-muted);
            width: 90px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .score-bar-track {
            flex: 1;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }

        .score-bar-fill.fp { background: var(--cyan); }
        .score-bar-fill.quality { background: var(--magenta); }
        .score-bar-fill.semantic { background: var(--lime); }

        .score-bar-value {
            font-size: 10px;
            color: var(--text-dim);
            width: 35px;
            text-align: right;
        }

        /* Answer Section */
        .answer-card {
            grid-column: 1 / -1;
        }

        .answer-content {
            padding: 20px;
            background: var(--deep);
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.7;
            min-height: 100px;
        }

        .answer-content.loading {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
        }

        .answer-content.loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Fingerprint Viz */
        .fingerprint-viz {
            margin-top: 16px;
            padding: 16px;
            background: var(--deep);
            border-radius: 8px;
        }

        .fingerprint-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .fingerprint-title {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fingerprint-chart {
            position: relative;
        }

        .fingerprint-bars {
            display: flex;
            gap: 4px;
            height: 60px;
            align-items: flex-end;
        }

        .fp-bar {
            flex: 1;
            background: linear-gradient(180deg, var(--cyan) 0%, var(--violet) 100%);
            border-radius: 2px 2px 0 0;
            min-width: 3px;
            transition: height 0.3s;
            position: relative;
        }

        .fp-bar:hover::after {
            content: attr(data-value);
            position: absolute;
            bottom: calc(100% + 4px);
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            color: var(--cyan);
            background: var(--surface);
            padding: 2px 4px;
            border-radius: 2px;
        }

        .fp-axis-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 9px;
            color: var(--text-muted);
        }

        .fp-y-axis {
            position: absolute;
            left: -30px;
            top: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 9px;
            color: var(--text-muted);
        }

        /* Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--text-dim);
            cursor: help;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Sample Queries */
        .sample-queries {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .sample-query {
            padding: 8px 12px;
            background: var(--deep);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sample-query:hover {
            border-color: var(--cyan);
            color: var(--cyan);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-dim);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Help Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px 24px;
            background: var(--elevated);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-family: 'Outfit', sans-serif;
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            background: var(--deep);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .modal-close:hover {
            border-color: var(--magenta);
            color: var(--magenta);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
        }

        .help-section {
            margin-bottom: 32px;
        }

        .help-section:last-child {
            margin-bottom: 0;
        }

        .help-section-title {
            font-family: 'Outfit', sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: var(--cyan);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .help-item {
            padding: 16px;
            background: var(--deep);
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .help-item-title {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-item-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .help-item-badge.metric { background: var(--cyan); color: var(--void); }
        .help-item-badge.zone { background: var(--violet); color: var(--text); }
        .help-item-badge.score { background: var(--lime); color: var(--void); }

        .help-item-desc {
            font-size: 12px;
            line-height: 1.6;
            color: var(--text-dim);
        }

        .help-item-formula {
            margin-top: 8px;
            padding: 8px 12px;
            background: var(--surface);
            border-radius: 4px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            color: var(--lime);
        }

        .help-item-range {
            margin-top: 8px;
            font-size: 11px;
            color: var(--amber);
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">R</div>
                <div class="logo-text">
                    <h1>Attention-Guided RAG</h1>
                    <span>Fingerprint-based Retrieval</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="help-btn" onclick="toggleHelp()">
                    <span>?</span> Glossary & Help
                </button>
                <div class="server-status">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Connecting...</span>
                </div>
            </div>
        </header>

        <main class="main">
            <!-- Query Analysis -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        Query Analysis
                        <div class="tooltip-container">
                            <span class="info-icon">?</span>
                            <div class="tooltip" style="width: 280px;">
                                <span class="tooltip-title">What is Query Analysis?</span>
                                <strong style="color: var(--lime);">This analyzes YOUR question to see if the AI needs to look up information.</strong><br><br>
                                Some questions are simple ("Hi, how are you?") - the AI can answer from memory.<br><br>
                                Other questions need facts ("What is the capital of France?") - the AI should look things up.<br><br>
                                <strong style="color: var(--cyan);">We detect this by looking at attention patterns!</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <textarea class="query-input" id="queryInput" placeholder="Enter your question...">What are the health benefits of green tea?</textarea>

                    <div class="sample-queries">
                        <div class="sample-query" onclick="setQuery('What is the capital of France?')">Capital of France</div>
                        <div class="sample-query" onclick="setQuery('Explain quantum entanglement')">Quantum Physics</div>
                        <div class="sample-query" onclick="setQuery('How does photosynthesis work?')">Photosynthesis</div>
                        <div class="sample-query" onclick="setQuery('Hello, how are you?')">Simple Greeting</div>
                    </div>

                    <div class="query-actions">
                        <button class="btn" onclick="analyzeQuery()">Analyze Query</button>
                        <button class="btn btn-secondary" onclick="runRAG()">Run RAG Pipeline</button>
                    </div>

                    <div class="retrieval-meter" id="retrievalMeter" style="display: none;">
                        <div class="meter-header">
                            <div class="meter-label">
                                <span>Retrieval Need</span>
                                <div class="tooltip-container">
                                    <span class="info-icon">?</span>
                                    <div class="tooltip" style="width: 300px;">
                                        <span class="tooltip-title">Does this question need external info?</span>
                                        <strong style="color: var(--lime);">This meter shows if the AI should look up information to answer your question.</strong><br><br>

                                        <strong style="color: var(--cyan);">Low (0-40%):</strong> Simple question. The AI can answer from what it knows. Example: "Hello!" or "What is 2+2?"<br><br>

                                        <strong style="color: var(--amber);">High (40-100%):</strong> Fact-seeking question. The AI is "searching" for information. Example: "What are the health benefits of green tea?"<br><br>

                                        <em>We detect this by looking at attention patterns - when the AI's attention is scattered and searching, it needs help!</em>
                                    </div>
                                </div>
                            </div>
                            <span id="retrievalScore">0%</span>
                        </div>
                        <div class="meter-bar">
                            <div class="meter-fill" id="meterFill" style="width: 0%"></div>
                        </div>
                        <div class="meter-scale">
                            <span>0% Self-contained</span>
                            <span>40% Threshold</span>
                            <span>100% Needs retrieval</span>
                        </div>
                        <div class="retrieval-decision" id="retrievalDecision"></div>
                    </div>

                    <div class="token-analysis" id="tokenAnalysis" style="display: none;">
                        <div class="section-header">
                            <span class="section-title">Token Classification</span>
                            <div class="tooltip-container">
                                <span class="info-icon">?</span>
                                <div class="tooltip" style="width: 300px;">
                                    <span class="tooltip-title">What are these colored tokens?</span>
                                    <strong style="color: var(--lime);">Each word piece (token) gets a color based on what the AI was "thinking" when processing it.</strong><br><br>

                                    <strong style="color: var(--cyan);">üîó Cyan = "I need information"</strong><br>
                                    These tokens are searching for facts. Words like "capital", "explain", "how" trigger information-seeking.<br><br>

                                    <strong style="color: var(--violet);">üî≠ Purple = "Connecting to earlier context"</strong><br>
                                    These tokens link to something mentioned way earlier.<br><br>

                                    <strong style="color: var(--text-muted);">üìù Gray = "Just grammar"</strong><br>
                                    Words like "the", "is", "a" - not important for understanding.
                                </div>
                            </div>
                        </div>
                        <div class="token-list" id="tokenList"></div>
                        <div class="legend">
                            <div class="legend-item tooltip-container">
                                <div class="legend-dot" style="background: var(--cyan)"></div>
                                Retrieval Anchor
                                <div class="tooltip" style="width: 260px;">
                                    <span class="tooltip-title">üîó Retrieval Anchor</span>
                                    <strong style="color: var(--lime);">Words that say "I need information!"</strong><br><br>
                                    These tokens triggered the AI to search for facts. When you see cyan, the AI was actively looking for something to answer the question.<br><br>
                                    <em>Examples:</em> "capital", "explain", "benefits", "how does"
                                </div>
                            </div>
                            <div class="legend-item tooltip-container">
                                <div class="legend-dot" style="background: var(--violet)"></div>
                                Long Range
                                <div class="tooltip" style="width: 260px;">
                                    <span class="tooltip-title">üî≠ Long Range</span>
                                    <strong style="color: var(--lime);">Words connecting to earlier context.</strong><br><br>
                                    These tokens are linking back to something mentioned way earlier in the text (50+ words back).<br><br>
                                    <em>Example:</em> Referring back to instructions or the original question.
                                </div>
                            </div>
                            <div class="legend-item tooltip-container">
                                <div class="legend-dot" style="background: var(--text-muted)"></div>
                                Syntax
                                <div class="tooltip" style="width: 260px;">
                                    <span class="tooltip-title">üìù Syntax (Grammar)</span>
                                    <strong style="color: var(--lime);">Just grammar words - not important for meaning.</strong><br><br>
                                    Words like "the", "is", "a", "of" - they help sentences flow but don't carry the main meaning.<br><br>
                                    <em>These are filtered out when ranking documents.</em>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Document Ranking -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        Document Ranking
                        <div class="tooltip-container">
                            <span class="info-icon">?</span>
                            <div class="tooltip" style="width: 300px;">
                                <span class="tooltip-title">How are documents ranked?</span>
                                <strong style="color: var(--lime);">We find documents that best match your question.</strong><br><br>

                                Traditional search just matches keywords. We go deeper - we find documents that the AI would naturally "attend to" when answering.<br><br>

                                <strong style="color: var(--cyan);">Score breakdown:</strong><br>
                                ‚Ä¢ <strong>35%</strong> - Fingerprint match (attention similarity)<br>
                                ‚Ä¢ <strong>25%</strong> - Document quality (focused, coherent)<br>
                                ‚Ä¢ <strong>40%</strong> - Keyword overlap (traditional match)<br><br>

                                <em>Higher score = better answer!</em>
                            </div>
                        </div>
                    </div>
                    <span style="font-size: 11px; color: var(--text-muted);" id="docCount">5 documents</span>
                </div>
                <div class="card-body">
                    <div class="document-list" id="documentList">
                        <!-- Documents will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Answer -->
            <div class="card answer-card">
                <div class="card-header">
                    <div class="card-title">
                        Generated Answer
                        <div class="tooltip-container">
                            <span class="info-icon">?</span>
                            <div class="tooltip" style="width: 280px;">
                                <span class="tooltip-title">The AI's Answer</span>
                                <strong style="color: var(--lime);">This is the AI's response to your question.</strong><br><br>

                                The AI uses the top-ranked documents as "context" - like giving it reference material to read before answering.<br><br>

                                <strong style="color: var(--cyan);">The bar chart below</strong> shows what the AI was "looking at" while writing the answer - you can see if it focused on nearby words (grammar) or distant context (facts).
                            </div>
                        </div>
                    </div>
                    <span style="font-size: 11px; color: var(--text-muted);" id="answerMeta"></span>
                </div>
                <div class="card-body">
                    <div class="answer-content" id="answerContent">
                        <div class="empty-state">
                            <div class="empty-state-icon">?</div>
                            <p>Run the RAG pipeline to see the answer</p>
                        </div>
                    </div>

                    <div class="fingerprint-viz" id="fingerprintViz" style="display: none;">
                        <div class="fingerprint-header">
                            <div class="fingerprint-title">
                                Generation Attention Fingerprint
                                <div class="tooltip-container">
                                    <span class="info-icon">?</span>
                                    <div class="tooltip" style="width: 300px;">
                                        <span class="tooltip-title">What is this bar chart?</span>
                                        <strong style="color: var(--lime);">This shows WHERE the AI was looking when it wrote the answer.</strong><br><br>

                                        <strong style="color: var(--cyan);">Reading the bars (left to right):</strong><br>
                                        ‚Ä¢ <strong>Local (0-10)</strong> - Recent words (grammar)<br>
                                        ‚Ä¢ <strong>Mid (10-50)</strong> - Earlier in sentence (meaning)<br>
                                        ‚Ä¢ <strong>Long (50+)</strong> - Way back (instructions/facts)<br>
                                        ‚Ä¢ <strong>Entropy</strong> - How spread out attention is<br><br>

                                        <strong>Taller bar = more attention there</strong><br>
                                        High "Mid" bars = AI was connecting concepts<br>
                                        High "Local" bars = AI was doing grammar
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="fingerprint-chart">
                            <div class="fingerprint-bars" id="fingerprintBars"></div>
                            <div class="fp-axis-labels">
                                <span>Local (0-10)</span>
                                <span>Mid (10-50)</span>
                                <span>Long (50+)</span>
                                <span>Entropy</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Glossary & How It Works</div>
                <button class="modal-close" onclick="toggleHelp()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Beginner Introduction -->
                <div class="help-section">
                    <div class="help-section-title">
                        <span style="color: var(--lime);">&#9679;</span>
                        What is RAG? (Plain English)
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(0,229,255,0.1), rgba(180,255,0,0.1)); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: 13px; color: var(--text); line-height: 1.8;">
                            <strong style="color: var(--cyan);">RAG = Retrieval-Augmented Generation</strong><br><br>
                            Think of it like this: when you ask the AI a fact question, it's like asking someone who hasn't studied for an exam. They might guess wrong!<br><br>
                            <strong style="color: var(--lime);">RAG gives the AI a "cheat sheet"</strong> - it finds relevant documents first, then lets the AI read them before answering. Much more accurate!<br><br>
                            <strong style="color: var(--amber);">This tool shows you:</strong><br>
                            1. Does your question need a cheat sheet? (Retrieval Need)<br>
                            2. Which documents are most relevant? (Document Ranking)<br>
                            3. How did the AI use them? (Attention Fingerprint)
                        </div>
                    </div>
                </div>

                <!-- LLM Interpretation Guide -->
                <div class="help-section">
                    <div class="help-section-title">
                        <span style="color: var(--magenta);">&#9679;</span>
                        üí° Ask the AI to Explain Results!
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(180,255,0,0.15), rgba(255,0,153,0.15)); padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 1px solid var(--border);">
                        <div style="font-size: 12px; color: var(--text); line-height: 1.8;">
                            <strong style="color: var(--lime);">You can ask the same AI to interpret what you see!</strong><br><br>
                            <strong>Try these prompts:</strong><br><br>
                            <div style="background: var(--void); padding: 10px; border-radius: 6px; margin: 8px 0; font-family: monospace; font-size: 11px;">
                            "My query 'What are the health benefits of green tea?' got a retrieval need score of 72%. The word 'benefits' was classified as a Semantic Bridge. What does this tell us?"
                            </div>
                            <div style="background: var(--void); padding: 10px; border-radius: 6px; margin: 8px 0; font-family: monospace; font-size: 11px;">
                            "Document A scored 0.85 and Document B scored 0.45. A was about tea health benefits, B was about tea history. Why did A rank higher for a health question?"
                            </div>
                            <div style="background: var(--void); padding: 10px; border-radius: 6px; margin: 8px 0; font-family: monospace; font-size: 11px;">
                            "The attention fingerprint shows high 'mid-range' bars. What does that mean about how the AI generated its answer?"
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Basic Concepts -->
                <div class="help-section">
                    <div class="help-section-title">
                        <span style="color: var(--cyan);">&#9679;</span>
                        Key Concepts (No Jargon)
                    </div>
                    <div class="help-grid">
                        <div class="help-item">
                            <div class="help-item-title">
                                <span style="color: var(--cyan);">T</span>
                                Token
                            </div>
                            <div class="help-item-desc">
                                A piece of text - usually a word or part of a word. "Hello" = 1 token. "unhappiness" = 3 tokens.
                            </div>
                        </div>
                        <div class="help-item">
                            <div class="help-item-title">
                                <span style="color: var(--magenta);">A</span>
                                Attention
                            </div>
                            <div class="help-item-desc">
                                Where the AI "looks" when processing each word. Like highlighting which parts of your question matter most.
                            </div>
                        </div>
                        <div class="help-item">
                            <div class="help-item-title">
                                <span style="color: var(--lime);">F</span>
                                Fingerprint
                            </div>
                            <div class="help-item-desc">
                                A summary of the AI's attention pattern - like a unique signature showing what it was thinking.
                            </div>
                        </div>
                        <div class="help-item">
                            <div class="help-item-title">
                                <span style="color: var(--amber);">R</span>
                                Retrieval Need
                            </div>
                            <div class="help-item-desc">
                                How much your question needs external info. "Hi!" = low. "What is quantum physics?" = high.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attention Zones Section -->
                <div class="help-section">
                    <div class="help-section-title">
                        <span style="color: var(--violet);">&#9679;</span>
                        Attention Zones (Token Classification)
                    </div>
                    <div style="background: var(--deep); border-left: 3px solid var(--violet); padding: 12px 16px; margin-bottom: 16px; border-radius: 0 6px 6px 0;">
                        <div style="font-size: 11px; font-weight: 600; color: var(--violet); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">What are these colors?</div>
                        <div style="font-size: 12px; color: var(--text-dim); line-height: 1.6;">
                            Each word gets a color based on <strong style="color: var(--text);">where the AI was looking</strong> when it processed that word.
                            Colors reveal the AI's "focus" - is it doing grammar (local) or retrieving facts (semantic bridge)?
                        </div>
                    </div>
                    <div class="help-grid">
                        <div class="help-item">
                            <div class="help-item-title">
                                <span style="color: var(--cyan);">&#9632;</span>
                                Semantic Bridge
                                <span class="help-item-badge zone">ZONE</span>
                            </div>
                            <div class="help-item-desc">
                                Tokens that actively seek information by attending to mid-range context. These are "retrieval anchors" - words that indicate the model needs external knowledge.
                            </div>
                            <div class="help-item-formula">
                                Condition: mid_mass > 0.4 AND entropy > 0.5
                            </div>
                            <div class="help-item-range">
                                Importance: 0.9 (high) | Examples: "What", "explain", "capital"
                            </div>
                            <div style="margin-top: 8px; padding: 8px; background: var(--void); border-radius: 4px; font-size: 11px; color: var(--text-muted);">
                                <strong style="color: var(--violet);">Architecture:</strong> Later transformer layers learn semantic key-value representations.
                                When query vectors match keys across sentence boundaries, attention flows to semantically related tokens regardless of position.
                            </div>
                        </div>
                        <div class="help-item">
                            <div class="help-item-title">
                                <span style="color: var(--violet);">&#9632;</span>
                                Long Range
                                <span class="help-item-badge zone">ZONE</span>
                            </div>
                            <div class="help-item-desc">
                                Tokens that connect to distant context (>50 tokens away). Important for maintaining coherence across long documents and connecting related concepts.
                            </div>
                            <div class="help-item-formula">
                                Condition: long_mass > 0.4
                            </div>
                            <div class="help-item-range">
                                Importance: 0.8 | Examples: pronouns referring back, topic words
                            </div>
                            <div style="margin-top: 8px; padding: 8px; background: var(--void); border-radius: 4px; font-size: 11px; color: var(--text-muted);">
                                <strong style="color: var(--violet);">Architecture:</strong> "Attention sinks" (BOS/instruction tokens) receive persistent attention.
                                Specialized "global" attention heads maintain connection to system prompts throughout generation.
                            </div>
                        </div>
                        <div class="help-item">
                            <div class="help-item-title">
                                <span style="color: var(--text-muted);">&#9632;</span>
                                Syntax Floor
                                <span class="help-item-badge zone">ZONE</span>
                            </div>
                            <div class="help-item-desc">
                                Local grammatical tokens with focused attention on nearby words. These can be reconstructed from context and have low semantic importance.
                            </div>
                            <div class="help-item-formula">
                                Condition: local_mass > 0.6 AND entropy < 2.5
                            </div>
                            <div class="help-item-range">
                                Importance: 0.3 (low) | Examples: "the", "is", "of", ","
                            </div>
                            <div style="margin-top: 8px; padding: 8px; background: var(--void); border-radius: 4px; font-size: 11px; color: var(--text-muted);">
                                <strong style="color: var(--violet);">Architecture:</strong> RoPE (Rotary Position Embeddings) creates natural distance decay.
                                Early transformer layers specialize in syntax and naturally attend locally. This is the "baseline" attention pattern.
                            </div>
                        </div>
                        <div class="help-item">
                            <div class="help-item-title">
                                <span style="color: var(--amber);">&#9632;</span>
                                Diffuse
                                <span class="help-item-badge zone">ZONE</span>
                            </div>
                            <div class="help-item-desc">
                                Tokens with scattered, unfocused attention. High entropy but no dominant attention pattern. Often indicates uncertainty or transition points.
                            </div>
                            <div class="help-item-formula">
                                Condition: total_mass < 0.5 AND entropy > 3.0
                            </div>
                            <div class="help-item-range">
                                Importance: 0.2 (low) | May indicate model confusion
                            </div>
                            <div style="margin-top: 8px; padding: 8px; background: var(--void); border-radius: 4px; font-size: 11px; color: var(--text-muted);">
                                <strong style="color: var(--violet);">Architecture:</strong> When no key vectors strongly match the query,
                                softmax produces near-uniform distribution. This happens at decision points where multiple continuations are equally plausible.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fingerprint Metrics Section -->
                <div class="help-section">
                    <div class="help-section-title">
                        <span style="color: var(--cyan);">&#9679;</span>
                        Fingerprint Components
                    </div>
                    <div style="background: var(--deep); border-left: 3px solid var(--cyan); padding: 12px 16px; margin-bottom: 16px; border-radius: 0 6px 6px 0;">
                        <div style="font-size: 11px; font-weight: 600; color: var(--cyan); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">How Fingerprints Are Computed</div>
                        <div style="font-size: 12px; color: var(--text-dim); line-height: 1.6;">
                            <strong style="color: var(--text);">1.</strong> Extract attention weights <code style="background: var(--void); padding: 2px 6px; border-radius: 3px; font-size: 11px;">A[i,j]</code> from the final transformer layer<br>
                            <strong style="color: var(--text);">2.</strong> Bin weights by distance: how many tokens back each attended position is<br>
                            <strong style="color: var(--text);">3.</strong> Aggregate into local/mid/long mass and compute entropy<br>
                            <strong style="color: var(--text);">4.</strong> Normalize to create a 20-dimensional fingerprint vector
                        </div>
                    </div>
                    <div class="help-grid">
                        <div class="help-item">
                            <div class="help-item-title">
                                Local Mass
                                <span class="help-item-badge metric">METRIC</span>
                            </div>
                            <div class="help-item-desc">
                                Fraction of attention going to nearby tokens (within 10 positions). High values indicate local/syntactic processing.
                            </div>
                            <div class="help-item-formula">
                                local_mass = sum(attention[i-10:i]) / sum(attention)
                            </div>
                            <div class="help-item-range">
                                Range: 0.0 - 1.0 | High (>0.6) = syntax processing
                            </div>
                            <div style="margin-top: 6px; font-size: 10px; color: var(--text-muted);">
                                <strong style="color: var(--cyan);">Source:</strong> RoPE position encoding creates natural distance decay in dot products
                            </div>
                        </div>
                        <div class="help-item">
                            <div class="help-item-title">
                                Mid-Range Mass
                                <span class="help-item-badge metric">METRIC</span>
                            </div>
                            <div class="help-item-desc">
                                Fraction of attention going to tokens 10-50 positions away. High values indicate semantic/conceptual connections.
                            </div>
                            <div class="help-item-formula">
                                mid_mass = sum(attention[i-50:i-10]) / sum(attention)
                            </div>
                            <div class="help-item-range">
                                Range: 0.0 - 1.0 | High (>0.4) = semantic bridge
                            </div>
                            <div style="margin-top: 6px; font-size: 10px; color: var(--text-muted);">
                                <strong style="color: var(--cyan);">Source:</strong> Semantic attention heads learn key-value pairs that match concepts
                            </div>
                        </div>
                        <div class="help-item">
                            <div class="help-item-title">
                                Long-Range Mass
                                <span class="help-item-badge metric">METRIC</span>
                            </div>
                            <div class="help-item-desc">
                                Fraction of attention going to distant tokens (>50 positions). High values indicate cross-document connections.
                            </div>
                            <div class="help-item-formula">
                                long_mass = sum(attention[0:i-50]) / sum(attention)
                            </div>
                            <div class="help-item-range">
                                Range: 0.0 - 1.0 | High (>0.4) = long-range zone
                            </div>
                            <div style="margin-top: 6px; font-size: 10px; color: var(--text-muted);">
                                <strong style="color: var(--cyan);">Source:</strong> Global/instruction-following heads attend to system prompts
                            </div>
                        </div>
                        <div class="help-item">
                            <div class="help-item-title">
                                Attention Entropy
                                <span class="help-item-badge metric">METRIC</span>
                            </div>
                            <div class="help-item-desc">
                                Measures how spread out the attention is. Low entropy = focused on few tokens. High entropy = distributed across many.
                            </div>
                            <div class="help-item-formula">
                                entropy = -sum(p * log(p)) where p = attention probs
                            </div>
                            <div class="help-item-range">
                                Range: 0.0 - 4.0+ | Low (<2.0) = focused, High (>3.0) = diffuse
                            </div>
                            <div style="margin-top: 6px; font-size: 10px; color: var(--text-muted);">
                                <strong style="color: var(--cyan);">Source:</strong> Softmax temperature controls entropy. High logit variance ‚Üí sharp attention.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scoring Metrics Section -->
                <div class="help-section">
                    <div class="help-section-title">
                        <span style="color: var(--lime);">&#9679;</span>
                        Document Scoring
                    </div>
                    <div style="background: var(--deep); border-left: 3px solid var(--lime); padding: 12px 16px; margin-bottom: 16px; border-radius: 0 6px 6px 0;">
                        <div style="font-size: 11px; font-weight: 600; color: var(--lime); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Attention-Guided Document Ranking</div>
                        <div style="font-size: 12px; color: var(--text-dim); line-height: 1.6;">
                            Unlike traditional RAG (keyword/embedding similarity), we use <strong style="color: var(--text);">attention fingerprints</strong>
                            to match documents. This captures <em>how the model would attend</em> to the document, not just lexical overlap.
                            Documents whose fingerprints align with query "semantic bridge" tokens are likely to satisfy the information need.
                        </div>
                    </div>
                    <div class="help-grid">
                        <div class="help-item">
                            <div class="help-item-title">
                                FP Similarity
                                <span class="help-item-badge score">SCORE</span>
                            </div>
                            <div class="help-item-desc">
                                <strong>Fingerprint Similarity</strong> - How well the document's attention fingerprint matches the query's anchor tokens. Documents with similar fingerprint patterns to the query anchors score higher.
                            </div>
                            <div class="help-item-formula">
                                fp_sim = cosine_similarity(query_fp, doc_fp)
                            </div>
                            <div class="help-item-range">
                                Range: 0.0 - 1.0 | Weight in final: 35%
                            </div>
                        </div>
                        <div class="help-item">
                            <div class="help-item-title">
                                Target Quality
                                <span class="help-item-badge score">SCORE</span>
                            </div>
                            <div class="help-item-desc">
                                <strong>TQ = Target Quality</strong> - How good the document is as a retrieval target. Documents with focused, low-entropy attention patterns make better targets (more coherent information).
                            </div>
                            <div class="help-item-formula">
                                target_quality = 1 - avg_entropy(doc_fingerprint)
                            </div>
                            <div class="help-item-range">
                                Range: 0.0 - 1.0 | Weight in final: 25%
                            </div>
                        </div>
                        <div class="help-item">
                            <div class="help-item-title">
                                Semantic Score
                                <span class="help-item-badge score">SCORE</span>
                            </div>
                            <div class="help-item-desc">
                                Traditional text matching score. Measures keyword overlap between query tokens and document text. Complements attention-based scoring.
                            </div>
                            <div class="help-item-formula">
                                semantic = matching_tokens / total_query_tokens
                            </div>
                            <div class="help-item-range">
                                Range: 0.0 - 1.0 | Weight in final: 40%
                            </div>
                        </div>
                        <div class="help-item">
                            <div class="help-item-title">
                                Final Score
                                <span class="help-item-badge score">SCORE</span>
                            </div>
                            <div class="help-item-desc">
                                Combined ranking score used to order documents. Balances attention-based metrics with traditional semantic matching.
                            </div>
                            <div class="help-item-formula">
                                final = 0.35*FP_sim + 0.25*TQ + 0.40*semantic
                            </div>
                            <div class="help-item-range">
                                Range: 0.0 - 1.0 | Documents sorted by this score
                            </div>
                        </div>
                    </div>
                </div>

                <!-- How It Works Section -->
                <div class="help-section">
                    <div class="help-section-title">
                        <span style="color: var(--magenta);">&#9679;</span>
                        How Attention-Guided RAG Works
                    </div>
                    <div class="help-item" style="margin-bottom: 16px;">
                        <div class="help-item-desc" style="font-size: 13px; line-height: 1.8;">
                            <strong>1. Query Analysis:</strong> When you enter a query, we analyze its tokens using attention fingerprints. Tokens are classified into zones (semantic_bridge, long_range, syntax_floor) based on their attention patterns.<br><br>

                            <strong>2. Retrieval Need Detection:</strong> If many tokens are "semantic bridges" (actively seeking information), the query has high retrieval need. Simple greetings or self-contained questions have low retrieval need.<br><br>

                            <strong>3. Document Scoring:</strong> Each candidate document is scored by:<br>
                            &nbsp;&nbsp;&bull; <strong>FP Similarity:</strong> How well its fingerprint matches query anchors<br>
                            &nbsp;&nbsp;&bull; <strong>Target Quality:</strong> How focused/coherent the document is<br>
                            &nbsp;&nbsp;&bull; <strong>Semantic Match:</strong> Traditional keyword overlap<br><br>

                            <strong>4. Answer Generation:</strong> Top-ranked documents are used as context for generating the answer. The fingerprint visualization shows how attention was distributed during generation.
                        </div>
                    </div>

                    <!-- Visual RAG Pipeline -->
                    <div style="background: var(--void); padding: 16px; border-radius: 8px; margin-top: 16px;">
                        <div style="font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: var(--text-dim); overflow-x: auto;">
<pre style="margin: 0; line-height: 1.5;">
<span style="color: #00e5ff;">THE RAG PIPELINE - Visual Flow</span>

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  <span style="color: #ffaa00;">STEP 1: YOUR QUERY</span>                                                     ‚îÇ
‚îÇ  "What are the health benefits of green tea?"                           ‚îÇ
‚îÇ                                                                          ‚îÇ
‚îÇ  We analyze each word:                                                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇWhat ‚îÇ ‚îÇ are ‚îÇ ‚îÇ the ‚îÇ ‚îÇhealth‚îÇ ‚îÇbenefits‚îÇ ‚îÇ of  ‚îÇ ‚îÇgreen‚îÇ ‚îÇ tea ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ     ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ        ‚îÇ         ‚îÇ       ‚îÇ       ‚îÇ        ‚îÇ
‚îÇ   <span style="color: #00e5ff;">CYAN</span>    gray    gray   <span style="color: #00e5ff;">CYAN</span>     <span style="color: #00e5ff;">CYAN</span>      gray    <span style="color: #00e5ff;">CYAN</span>    <span style="color: #00e5ff;">CYAN</span>      ‚îÇ
‚îÇ  anchor  syntax  syntax  anchor   anchor    syntax  anchor  anchor     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                    ‚îÇ
                                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  <span style="color: #ff0099;">STEP 2: COMPUTE RETRIEVAL NEED</span>                                        ‚îÇ
‚îÇ                                                                          ‚îÇ
‚îÇ  Count "information-seeking" tokens (cyan = semantic bridges)           ‚îÇ
‚îÇ                                                                          ‚îÇ
‚îÇ  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  <span style="color: #b4ff00;">65% RETRIEVAL NEED</span>             ‚îÇ
‚îÇ                                                                          ‚îÇ
‚îÇ  High % = "This question needs external information!"                   ‚îÇ
‚îÇ  Low %  = "AI can answer from memory"                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                    ‚îÇ
                                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  <span style="color: #b4ff00;">STEP 3: SCORE DOCUMENTS</span>                                               ‚îÇ
‚îÇ                                                                          ‚îÇ
‚îÇ  For each document, compute:                                            ‚îÇ
‚îÇ                                                                          ‚îÇ
‚îÇ  Document: "Green Tea Benefits"                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îÇ
‚îÇ  ‚îÇ FP Similarity   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë  69%  (35%)     ‚îÇ           ‚îÇ
‚îÇ  ‚îÇ Target Quality  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë  78%  (25%)     ‚îÇ           ‚îÇ
‚îÇ  ‚îÇ Semantic Match  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  50%  (40%)     ‚îÇ           ‚îÇ
‚îÇ  ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ      ‚îÇ           ‚îÇ
‚îÇ  ‚îÇ <span style="color: #00e5ff;">FINAL SCORE</span>     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  <span style="color: #00e5ff;">63%</span>             ‚îÇ           ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                    ‚îÇ
                                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  <span style="color: #a855f7;">STEP 4: GENERATE ANSWER</span>                                               ‚îÇ
‚îÇ                                                                          ‚îÇ
‚îÇ  AI reads top documents as "context" then generates answer:             ‚îÇ
‚îÇ                                                                          ‚îÇ
‚îÇ  "Green tea offers numerous health benefits including improved          ‚îÇ
‚îÇ   metabolism, heart health support, and antioxidant properties..."      ‚îÇ
‚îÇ                                                                          ‚îÇ
‚îÇ  The fingerprint chart shows WHERE the AI looked during generation!     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</pre>
                        </div>
                    </div>
                </div>

                <!-- How Layers Build Understanding -->
                <div class="help-section">
                    <div class="help-section-title">
                        <span style="color: var(--cyan);">&#9679;</span>
                        How Transformer Layers Build Understanding
                    </div>
                    <div style="background: var(--deep); padding: 16px; border-radius: 8px;">
                        <div style="font-size: 12px; color: var(--text); line-height: 1.8; margin-bottom: 12px;">
                            <strong style="color: var(--cyan);">The AI processes your query through ~32 layers (like floors in a building):</strong>
                        </div>
                        <div style="font-family: 'IBM Plex Mono', monospace; font-size: 10px; background: var(--void); padding: 12px; border-radius: 6px; overflow-x: auto;">
<pre style="margin: 0; color: var(--text-dim); line-height: 1.4;">
<span style="color: #ffaa00;">Layer 1-4</span>   ‚îÇ Tokenize ‚Üí basic patterns ‚Üí word shapes
            ‚îÇ Attention: <span style="color: #ffaa00;">LOCAL</span> (nearby words only)
            ‚îÇ
<span style="color: #ff0099;">Layer 5-12</span>  ‚îÇ Phrase structure ‚Üí sentence parsing
            ‚îÇ Attention: LOCAL + some MID-RANGE
            ‚îÇ
<span style="color: #00e5ff;">Layer 13-24</span> ‚îÇ <span style="color: #00e5ff;">SEMANTIC UNDERSTANDING</span> ‚Üê We capture this!
            ‚îÇ Connects: "health" ‚Üî "benefits" ‚Üî "tea"
            ‚îÇ Attention: strong <span style="color: #00e5ff;">MID-RANGE</span> (semantic bridges)
            ‚îÇ
<span style="color: #b4ff00;">Layer 25-32</span> ‚îÇ Final reasoning ‚Üí answer generation
            ‚îÇ Attention: includes <span style="color: #b4ff00;">LONG-RANGE</span> (instructions)
</pre>
                        </div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 12px;">
                            <strong style="color: var(--lime);">We show you the final layer's attention</strong> - this is where the AI makes its final decision about what information to use.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sample documents for demo
        const sampleDocuments = [
            {
                id: 1,
                title: "Green Tea Benefits",
                text: "Green tea contains catechins and antioxidants that boost metabolism, support heart health, and may reduce the risk of certain cancers. The polyphenols in green tea have anti-inflammatory properties.",
                fingerprint: [0.2, 0.5, 0.3, 0.25, 0.1, 0.15, 0.2, 0.1]
            },
            {
                id: 2,
                title: "Tea History",
                text: "Tea has been consumed for thousands of years, originating in China. It spread to Japan, then to Europe through trade routes. Today, tea is the second most consumed beverage worldwide after water.",
                fingerprint: [0.3, 0.4, 0.3, 0.4, 0.2, 0.1, 0.15, 0.2]
            },
            {
                id: 3,
                title: "Coffee vs Tea",
                text: "Coffee contains more caffeine than tea but lacks the L-theanine that gives tea its calming properties. Both beverages have antioxidants, though they differ in type and concentration.",
                fingerprint: [0.35, 0.35, 0.25, 0.5, 0.15, 0.2, 0.1, 0.25]
            },
            {
                id: 4,
                title: "Cardiovascular Health",
                text: "Regular tea consumption has been associated with reduced risk of cardiovascular disease. Studies show that drinking 3-4 cups of green tea daily may lower blood pressure and cholesterol levels.",
                fingerprint: [0.15, 0.55, 0.3, 0.2, 0.1, 0.2, 0.25, 0.15]
            },
            {
                id: 5,
                title: "Weather Report",
                text: "Today's weather will be sunny with temperatures around 75 degrees Fahrenheit. Expect clear skies throughout the day with light winds from the southwest.",
                fingerprint: [0.4, 0.3, 0.2, 0.8, 0.3, 0.25, 0.1, 0.3]
            }
        ];

        // State
        let currentQuery = "";
        let queryAnalysis = null;
        let rankedDocuments = [];
        let serverUrl = "http://localhost:30000";
        let isConnected = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkServerConnection();
            renderDocuments(sampleDocuments.map((d, i) => ({...d, score: 0, rank: i + 1})));
        });

        function toggleHelp() {
            const modal = document.getElementById('helpModal');
            modal.classList.toggle('active');
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.getElementById('helpModal').classList.remove('active');
            }
        });

        // Close modal on overlay click
        document.getElementById('helpModal').addEventListener('click', (e) => {
            if (e.target.id === 'helpModal') {
                toggleHelp();
            }
        });

        async function checkServerConnection() {
            try {
                const response = await fetch(`${serverUrl}/health`, { timeout: 3000 });
                if (response.ok) {
                    setConnectionStatus(true);
                } else {
                    setConnectionStatus(false);
                }
            } catch (e) {
                setConnectionStatus(false);
            }
        }

        function setConnectionStatus(connected) {
            isConnected = connected;
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');

            if (connected) {
                dot.className = 'status-dot connected';
                text.textContent = 'Connected';
            } else {
                dot.className = 'status-dot error';
                text.textContent = 'Demo Mode (no server)';
            }
        }

        function setQuery(query) {
            document.getElementById('queryInput').value = query;
        }

        async function analyzeQuery() {
            const query = document.getElementById('queryInput').value.trim();
            if (!query) return;

            currentQuery = query;

            // Simulate query analysis with synthetic fingerprints
            const tokens = query.split(/\s+/);
            const analysis = simulateQueryAnalysis(tokens);
            queryAnalysis = analysis;

            // Update UI
            showRetrievalMeter(analysis.retrievalNeed);
            showTokenAnalysis(tokens, analysis.tokenZones, analysis.anchors);

            // Score and rank documents
            scoreDocuments(analysis);
        }

        function simulateQueryAnalysis(tokens) {
            // Simulate zone classification based on token characteristics
            const questionWords = ['what', 'how', 'why', 'when', 'where', 'who', 'which', 'explain'];
            const topicWords = ['health', 'benefits', 'effects', 'causes', 'process', 'mechanism'];

            const tokenZones = tokens.map(token => {
                const lower = token.toLowerCase().replace(/[?.,!]/g, '');
                if (questionWords.includes(lower)) return 'semantic_bridge';
                if (topicWords.includes(lower)) return 'long_range';
                if (lower.length <= 3) return 'syntax_floor';
                return Math.random() > 0.5 ? 'semantic_bridge' : 'syntax_floor';
            });

            const anchors = tokenZones.map((zone, i) =>
                zone === 'semantic_bridge' || zone === 'long_range' ? i : -1
            ).filter(i => i >= 0);

            // Calculate retrieval need
            const semanticCount = tokenZones.filter(z => z === 'semantic_bridge').length;
            const longRangeCount = tokenZones.filter(z => z === 'long_range').length;
            const retrievalNeed = Math.min(1, (semanticCount * 0.15 + longRangeCount * 0.1 + 0.2));

            return {
                tokens,
                tokenZones,
                anchors,
                retrievalNeed
            };
        }

        function showRetrievalMeter(score) {
            const meter = document.getElementById('retrievalMeter');
            const scoreEl = document.getElementById('retrievalScore');
            const fill = document.getElementById('meterFill');
            const decision = document.getElementById('retrievalDecision');

            meter.style.display = 'block';
            scoreEl.textContent = `${Math.round(score * 100)}%`;
            fill.style.width = `${score * 100}%`;

            if (score >= 0.4) {
                decision.className = 'retrieval-decision retrieve';
                decision.textContent = 'RETRIEVE - Query needs external information';
            } else {
                decision.className = 'retrieval-decision skip';
                decision.textContent = 'SKIP - Query is self-contained';
            }
        }

        function showTokenAnalysis(tokens, zones, anchors) {
            const container = document.getElementById('tokenAnalysis');
            const list = document.getElementById('tokenList');

            container.style.display = 'block';
            list.innerHTML = tokens.map((token, i) => {
                const isAnchor = anchors.includes(i);
                const zone = zones[i];
                const zoneLabel = zone.replace('_', ' ');
                return `<span class="token ${zone} ${isAnchor ? 'anchor' : ''}" title="Zone: ${zoneLabel}">${token}</span>`;
            }).join('');
        }

        function scoreDocuments(analysis) {
            // Score each document based on fingerprint similarity and target quality
            const scored = sampleDocuments.map(doc => {
                // Simulate fingerprint similarity
                const fpSim = calculateSimilarity(analysis, doc);

                // Target quality based on document fingerprint entropy
                const avgEntropy = doc.fingerprint.reduce((a, b) => a + b, 0) / doc.fingerprint.length;
                const targetQuality = 1 - avgEntropy;

                // Check for keyword matches (semantic relevance)
                const queryLower = currentQuery.toLowerCase();
                const docLower = doc.text.toLowerCase();
                const keywordMatches = analysis.tokens.filter(t =>
                    docLower.includes(t.toLowerCase())
                ).length / analysis.tokens.length;

                // Combined score
                const score = 0.35 * fpSim + 0.25 * targetQuality + 0.4 * keywordMatches;

                return {
                    ...doc,
                    score,
                    fpSimilarity: fpSim,
                    targetQuality,
                    semanticScore: keywordMatches
                };
            });

            // Sort by score
            scored.sort((a, b) => b.score - a.score);
            scored.forEach((doc, i) => doc.rank = i + 1);

            rankedDocuments = scored;
            renderDocuments(scored);
        }

        function calculateSimilarity(analysis, doc) {
            // Simple similarity based on zone distribution
            const anchorRatio = analysis.anchors.length / analysis.tokens.length;
            const docFocus = 1 - (doc.fingerprint[3] || 0.5); // Lower entropy = more focused
            return 0.5 + 0.5 * (anchorRatio * docFocus);
        }

        function renderDocuments(documents) {
            const container = document.getElementById('documentList');
            document.getElementById('docCount').textContent = `${documents.length} documents`;

            container.innerHTML = documents.map(doc => `
                <div class="document-item" data-id="${doc.id}">
                    <div class="document-header">
                        <span class="document-title">#${doc.rank} ${doc.title}</span>
                        <span class="document-score" style="color: ${getScoreColor(doc.score)}">
                            ${doc.score ? (doc.score * 100).toFixed(0) + '%' : '-'}
                        </span>
                    </div>
                    <div class="document-text">${doc.text}</div>
                    ${doc.score ? `
                    <div class="score-bars">
                        <div class="score-bar">
                            <span class="score-bar-label">
                                FP Similarity
                                <span class="info-icon" style="width:12px;height:12px;font-size:8px;" title="Fingerprint Similarity: How well document matches query attention patterns">?</span>
                            </span>
                            <div class="score-bar-track">
                                <div class="score-bar-fill fp" style="width: ${(doc.fpSimilarity || 0) * 100}%"></div>
                            </div>
                            <span class="score-bar-value">${((doc.fpSimilarity || 0) * 100).toFixed(0)}%</span>
                        </div>
                        <div class="score-bar">
                            <span class="score-bar-label">
                                Target Quality
                                <span class="info-icon" style="width:12px;height:12px;font-size:8px;" title="Target Quality: How focused/coherent the document is (1 - entropy)">?</span>
                            </span>
                            <div class="score-bar-track">
                                <div class="score-bar-fill quality" style="width: ${(doc.targetQuality || 0) * 100}%"></div>
                            </div>
                            <span class="score-bar-value">${((doc.targetQuality || 0) * 100).toFixed(0)}%</span>
                        </div>
                        <div class="score-bar">
                            <span class="score-bar-label">
                                Semantic
                                <span class="info-icon" style="width:12px;height:12px;font-size:8px;" title="Semantic Match: Keyword overlap between query and document">?</span>
                            </span>
                            <div class="score-bar-track">
                                <div class="score-bar-fill semantic" style="width: ${(doc.semanticScore || 0) * 100}%"></div>
                            </div>
                            <span class="score-bar-value">${((doc.semanticScore || 0) * 100).toFixed(0)}%</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function getScoreColor(score) {
            if (!score) return 'var(--text-muted)';
            if (score >= 0.7) return 'var(--lime)';
            if (score >= 0.4) return 'var(--amber)';
            return 'var(--text-dim)';
        }

        async function runRAG() {
            if (!queryAnalysis) {
                await analyzeQuery();
            }

            const answerContent = document.getElementById('answerContent');
            const answerMeta = document.getElementById('answerMeta');
            const fpViz = document.getElementById('fingerprintViz');

            // Show loading
            answerContent.innerHTML = '';
            answerContent.className = 'answer-content loading';
            answerContent.textContent = 'Generating answer';

            // Get top 3 documents
            const topDocs = rankedDocuments.slice(0, 3);
            const context = topDocs.map(d => d.text).join('\n\n');

            // Try live generation or simulate
            let answer;
            if (isConnected) {
                try {
                    answer = await generateAnswer(currentQuery, context);
                } catch (e) {
                    answer = simulateAnswer(currentQuery, topDocs);
                }
            } else {
                // Simulate response
                await new Promise(r => setTimeout(r, 1000));
                answer = simulateAnswer(currentQuery, topDocs);
            }

            // Display answer
            answerContent.className = 'answer-content';
            answerContent.textContent = answer;
            answerMeta.textContent = `Using ${topDocs.length} sources`;

            // Show fingerprint visualization
            showFingerprintViz(topDocs);
        }

        async function generateAnswer(query, context) {
            const response = await fetch(`${serverUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'default',
                    messages: [{
                        role: 'user',
                        content: `Context:\n${context}\n\nQuestion: ${query}\n\nAnswer based on the context:`
                    }],
                    max_tokens: 300
                })
            });

            const data = await response.json();
            return data.choices[0].message.content;
        }

        function simulateAnswer(query, topDocs) {
            // Generate a simulated answer based on top documents
            const queryLower = query.toLowerCase();

            if (queryLower.includes('health') || queryLower.includes('benefit')) {
                return `Based on the retrieved information, ${topDocs[0].text.split('.')[0].toLowerCase()}. Additionally, ${topDocs[1] ? topDocs[1].text.split('.')[0].toLowerCase() : 'regular consumption has shown positive health effects'}. These benefits are attributed to the antioxidants and polyphenols present in the substance.`;
            }

            if (queryLower.includes('capital')) {
                return "Paris is the capital of France. It is located in the north-central part of the country along the Seine River and is known for landmarks like the Eiffel Tower.";
            }

            if (queryLower.includes('hello') || queryLower.includes('how are you')) {
                return "Hello! I'm doing well, thank you for asking. How can I help you today?";
            }

            return `Based on the available information: ${topDocs[0].text.split('.').slice(0, 2).join('. ')}.`;
        }

        function showFingerprintViz(docs) {
            const container = document.getElementById('fingerprintViz');
            const bars = document.getElementById('fingerprintBars');

            container.style.display = 'block';

            // Aggregate fingerprints from top docs
            const aggregated = docs[0].fingerprint.map((_, i) => {
                return docs.reduce((sum, d) => sum + (d.fingerprint[i] || 0), 0) / docs.length;
            });

            bars.innerHTML = aggregated.map((val, i) =>
                `<div class="fp-bar" style="height: ${val * 100}%" data-value="${(val * 100).toFixed(0)}%" title="Bucket ${i+1}: ${(val * 100).toFixed(1)}%"></div>`
            ).join('');
        }
    </script>
</body>
</html>

#!/bin/bash
echo "Starting server"

PREFIX="SM_SGLANG_"
ARG_PREFIX="--"

ARGS=()

# Parse environment variables with the specific prefix to convert to arguments
while IFS='=' read -r key value; do
    arg_name=$(echo "${key#"${PREFIX}"}" | tr '[:upper:]' '[:lower:]' | tr '_' '-')

    ARGS+=("${ARG_PREFIX}${arg_name}")
    if [ -n "$value" ]; then
        ARGS+=("$value")
    fi
done < <(env | grep "^${PREFIX}")

# Add default port only if not already set
if ! [[ " ${ARGS[@]} " =~ " --port " ]]; then
    ARGS+=(--port "${SM_SGLANG_PORT:-8080}")
fi

# Add default host only if not already set
if ! [[ " ${ARGS[@]} " =~ " --host " ]]; then
    ARGS+=(--host "${SM_SGLANG_HOST:-0.0.0.0}")
fi

# Add default model-path only if not already set
if ! [[ " ${ARGS[@]} " =~ " --model-path " ]]; then
    ARGS+=(--model-path "${SM_SGLANG_MODEL_PATH:-/opt/ml/model}")
fi

# Add conditional logic for multimodal generation runtime
if [[ "${SM_SGLANG_USE_MULTIMODAL}" == "true" ]]; then
    echo "Running command: python3 -m sglang.multimodal_gen.runtime.launch_server ${ARGS[@]}"
    exec python3 -m sglang.multimodal_gen.runtime.launch_server "${ARGS[@]}"
else
    echo "Running command: python3 -m sglang.launch_server ${ARGS[@]}"
    exec python3 -m sglang.launch_server "${ARGS[@]}"
fi

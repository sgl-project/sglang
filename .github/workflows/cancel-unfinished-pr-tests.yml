name: Cancel Unfinished PR Tests

on:
  pull_request:
    types: [synchronize]
  workflow_dispatch:
    inputs:
      workflows:
        description: 'Space-separated list of workflow filenames to cancel'
        required: true
        type: string
        default: 'pr-test.yml'

permissions:
  actions: write   # Needed to cancel runs
  contents: read   # Needed to read repo info
  pull-requests: read  # needed for gh pr view (labels)

jobs:
  cancel-pending-pr-test:
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI
        run: sudo apt-get install -y gh jq

      - name: Cancel unfinished PR-associated runs (skip high-priority PRs)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          WORKFLOWS: ${{ github.event.inputs.workflows || 'pr-test.yml' }}
        shell: bash
        run: |
          set -euo pipefail

          # Read the space-separated string from the input into a bash array
          read -r -a WORKFLOW_FILES <<< "${WORKFLOWS}"

          echo "Targeting ${#WORKFLOW_FILES[@]} workflow(s): ${WORKFLOWS}"

          for workflow_file in "${WORKFLOW_FILES[@]}"; do
            echo "--- Checking workflow: $workflow_file ---"

            gh run list \
              --repo "$REPO" \
              --workflow "$workflow_file" \
              --json databaseId,status,event,url \
              --limit 1000 \
            | jq -c '.[]
                | select(.event=="pull_request" and (.status=="queued" or .status=="waiting" or .status=="in_progress"))' \
            | while read -r run; do
                run_id=$(echo "$run" | jq -r '.databaseId')
                run_url=$(echo "$run" | jq -r '.url // empty')

                echo "Checking run $run_id ($run_url)"

                # Fetch full run details to get head repository and branch info
                run_details=$(gh api -H "Accept: application/vnd.github+json" \
                  "repos/$REPO/actions/runs/$run_id" 2>/dev/null || true)

                if [ -z "$run_details" ]; then
                  echo "‚ö†Ô∏è Could not fetch details for run $run_id, skipping"
                  continue
                fi

                # Get head owner and branch (works for both fork and non-fork PRs)
                head_owner=$(echo "$run_details" | jq -r '.head_repository.owner.login // empty')
                head_branch=$(echo "$run_details" | jq -r '.head_branch // empty')

                if [ -z "$head_owner" ] || [ -z "$head_branch" ]; then
                  echo "‚ö†Ô∏è Run $run_id missing head info (owner='$head_owner', branch='$head_branch'), skipping ($run_url)"
                  continue
                fi

                echo "  Head: ${head_owner}:${head_branch}"

                # Find PR by searching with head=owner:branch
                pr_number=$(gh api -H "Accept: application/vnd.github+json" \
                  "repos/$REPO/pulls?state=open&head=${head_owner}:${head_branch}" \
                  --jq '.[0].number // empty' 2>/dev/null || true)

                if [ -z "$pr_number" ]; then
                  echo "‚ö†Ô∏è No open PR found for ${head_owner}:${head_branch}, skipping run $run_id"
                  continue
                fi

                echo "  Associated with PR #$pr_number"

                # Debug when missing
                if [ -z "$pr_number" ]; then
                  echo "‚ö†Ô∏è Run $run_id PR not found (headBranch='$head_branch', headSha='$head_sha') ($run_url)"
                  continue
                fi

                # Check for high priority label
                labels=$(gh pr view "$pr_number" --repo "$REPO" --json labels \
                  | jq -r '.labels[].name' 2>/dev/null || true)

                if echo "$labels" | grep -Fxq "high priority"; then
                  echo "  üõë PR #$pr_number has 'high priority' label ‚Üí skipping cancel"
                  continue
                fi

                echo "üö´ Cancelling run $run_id (PR #$pr_number) $run_url"
                # gh run cancel "$run_id" --repo "$REPO" || echo "‚ö†Ô∏è Could not cancel run $run_id"
            done
          done

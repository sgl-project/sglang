name: Cancel Unfinished PR Tests

on:
  pull_request:
    types: [synchronize]
  workflow_dispatch:
    inputs:
      workflows:
        description: 'Space-separated list of workflow filenames to cancel'
        required: true
        type: string
        default: 'pr-test.yml'

permissions:
  actions: write   # Needed to cancel runs
  contents: read   # Needed to read repo info
  pull-requests: read  # needed for gh pr view (labels)

jobs:
  cancel-pending-pr-test:
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI
        run: sudo apt-get install -y gh jq

      - name: Cancel unfinished PR-associated runs (skip high-priority PRs)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          WORKFLOWS: ${{ github.event.inputs.workflows || 'pr-test.yml' }}
        shell: bash
        run: |
          set -euo pipefail

          # Read the space-separated string from the input into a bash array
          read -r -a WORKFLOW_FILES <<< "${WORKFLOWS}"

          echo "Targeting ${#WORKFLOW_FILES[@]} workflow(s): ${WORKFLOWS}"

          for workflow_file in "${WORKFLOW_FILES[@]}"; do
            echo "--- Checking workflow: $workflow_file ---"

            gh run list \
              --repo "$REPO" \
              --workflow "$workflow_file" \
              --json databaseId,status,event,url,headBranch \
              --limit 1000 \
            | jq -c '.[]
                | select(.event=="pull_request" and (.status=="queued" or .status=="waiting" or .status=="in_progress"))' \
            | while read -r run; do
                run_id=$(echo "$run" | jq -r '.databaseId')
                run_url=$(echo "$run" | jq -r '.url // empty')
                head_branch=$(echo "$run" | jq -r '.headBranch // empty')

                # Parse PR number from headBranch like "123/merge" or "pull/123/merge" or "refs/pull/123/merge"
                pr_number=$(echo "$head_branch" | sed -nE 's#^(refs/)?pull/([0-9]+)/merge$#\2#p')
                if [ -z "$pr_number" ]; then
                  pr_number=$(echo "$head_branch" | sed -nE 's#^([0-9]+)/merge$#\1#p')
                fi

                if [ -z "$pr_number" ]; then
                  echo "âš ï¸ Run $run_id not parseable as PR (headBranch='$head_branch'), skipping ($run_url)"
                  continue
                fi

                echo "Run $run_id is associated with PR #$pr_number (headBranch='$head_branch')"

                labels=$(gh pr view "$pr_number" --repo "$REPO" --json labels \
                  | jq -r '.labels[].name' || true)

                if echo "$labels" | grep -Fxq "high priority"; then
                  echo "ðŸ›‘ PR #$pr_number has label 'high priority' â†’ skip cancel"
                  continue
                fi

                echo "ðŸš« Cancelling run $run_id (PR #$pr_number) $run_url"
                gh run cancel "$run_id" --repo "$REPO" || echo "âš ï¸ Could not cancel run $run_id"
            done
          done

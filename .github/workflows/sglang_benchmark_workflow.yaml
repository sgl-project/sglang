name: SGLang Benchmark Workflow

on:
  pull_request:
    branches:
      - dev/perf
  workflow_dispatch:
    inputs:
      model_list:
        description: 'Model list to benchmark on MI355 (JSON array format, default: ["Qwen3-VL-235B","Qwen3-next","Qwen3-Omni"])'
        required: false
        default: '["Qwen3-VL-235B","Qwen3-next","Qwen3-Omni"]'
      image:
        description: 'Image to use for the benchmark (default: "rocm/ali-private:ubuntu22.04_rocm7.0.1.42_vllm_e858fc9_sglang_890fc1c_aiter_1b3efa9_torch2.8.0_20251125")'
        required: true
        default: "rocm/ali-private:ubuntu22.04_rocm7.0.1.42_vllm_e858fc9_sglang_890fc1c_aiter_1b3efa9_torch2.8.0_20251125"
  
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SGLANG_GITHUB_REPO_URL: ${{ github.event.pull_request.head.repo.clone_url || 'https://github.com/zejunchen-zejun/sglang.git' }}
  SGLANG_GITHUB_COMMIT_SHA: ${{ github.event.pull_request.head.sha || github.event.head_commit.id }}

jobs:
  benchmark:
    runs-on: sglang-mi308-8gpu
    strategy:
      fail-fast: false
      matrix:
        model: ${{ fromJson(github.event.inputs.model_list || '["Qwen3-VL-235B","Qwen3-next","Qwen3-Omni"]') }} 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download SGLang Image
        run: |
          docker login -u rocmshared -p ${{ secrets.DOCKER_PASSWORD }} || true
          for i in {1..3}; do
            docker pull ${{ github.event.inputs.image || 'rocm/ali-private:ubuntu22.04_rocm7.0.1.42_vllm_e858fc9_sglang_890fc1c_aiter_1b3efa9_torch2.8.0_20251125' }} && break || {
              echo "docker pull failed, retrying ($i/3)..."
              sleep 5
            }
          done
    
      - name: Generate Dockerfile
        run: |
          cat <<'EOF' > Dockerfile.mod
          FROM ${{ github.event.inputs.image || 'rocm/ali-private:ubuntu22.04_rocm7.0.1.42_vllm_e858fc9_sglang_890fc1c_aiter_1b3efa9_torch2.8.0_20251125' }}
          ENV GPU_ARCHS="gfx942"
          ENV PYTORCH_ROCM_ARCH="gfx942"
          RUN echo "=== Aiter version BEFORE uninstall ===" && pip show aiter || true
          RUN pip uninstall -y aiter
          RUN rm -rf /opt/aiter/aiter/jit/build
          RUN rm -rf /opt/aiter/aiter/jit/*.so
          RUN rm -rf ~/.aiter
          RUN pip install --upgrade "pybind11>=3.0.1"
          RUN pip show pybind11

          RUN git clone https://github.com/ZLkanyo009/aiter.git /aiter && \
            cd /aiter && \
            git checkout caa3a9b404b757f15effb7acfafb1bfa7573ecac && \
            git submodule sync && git submodule update --init --recursive && \
            python3 setup.py develop

          RUN echo "=== Aiter version AFTER installation ===" && pip show aiter || true

          RUN echo "=== Prebuilt Aiter kernel with op test ==="
          RUN cd /aiter/op_tests/ && \
            python3 test_rope.py && \
            python3 test_rmsnorm2d.py && \
            python3 test_rmsnorm2dFusedAddQuant.py

          RUN echo "=== sgl-kernel version before installation ===" && pip show sgl-kernel || true
          RUN echo "=== sglang version before installation ===" && pip show sglang || true
          RUN pip uninstall -y sgl-kernel sglang
          RUN git clone ${{ env.SGLANG_GITHUB_REPO_URL }} /sglang-checkout && \
              cd /sglang-checkout && \
              git checkout ${{ env.SGLANG_GITHUB_COMMIT_SHA }} && \
              git rev-parse HEAD && \
              pip install --upgrade pip && \
              pip install "transformers>=4.57.0" && \
              cd sgl-kernel && \
              python3 setup_rocm.py install && \
              cd .. && \
              rm -rf python/pyproject.toml && mv python/pyproject_other.toml python/pyproject.toml && \
              pip install -e "python[all_hip]"
          RUN echo "=== sgl-kernel version after installation ===" && pip show sgl-kernel || true
          RUN echo "=== sglang version after installation ===" && pip show sglang || true
          EOF

      - name: Show dockerfile
        run: |
          cat Dockerfile.mod 

      - name: Build Docker image
        run: |
          docker build --no-cache --network=host -t "sglang_test:ci" -f Dockerfile.mod .
    

      - name: Start CI container
        run: |
          echo "Clean up containers..."
          docker ps -aq -f name=sglang_test | xargs -r docker stop | xargs -r docker rm

          if [ -f "/etc/podinfo/gha-render-devices" ]; then
            DEVICE_FLAG=$(cat /etc/podinfo/gha-render-devices)
          else
            DEVICE_FLAG="--device /dev/dri"
          fi

          echo "Starting container: sglang_test:ci"
          docker run -dt --user root --device=/dev/kfd $DEVICE_FLAG \
          --ipc=host --group-add video \
          --shm-size 16g \
          --network=host \
          --privileged \
          --cap-add=SYS_PTRACE \
          -v /models:/models \
          --security-opt seccomp=unconfined \
          -w /sglang-checkout \
          --name sglang_test \
          sglang_test:ci

      - name: Show Aiter version
        run: |
          docker exec sglang_test bash -c "pip show aiter"

      - name: Show /dev/shm size
        run: |
          docker exec sglang_test bash -c "df -h /dev/shm"

      - name: Launch the server
        timeout-minutes: 60
        run: |
          set -ex
          model_name=${{ matrix.model }}
          if [ "$model_name" == "Qwen3-VL-235B" ]; then
            docker exec sglang_test bash -c "scripts/ci/sglang_benchmark_workflow.sh launch $model_name /models/RedHatAI/Qwen3-VL-235B-A22B-Instruct-FP8-dynamic/ 8 8"
          elif [ "$model_name" == "Qwen3-next" ]; then
            docker exec sglang_test bash -c "scripts/ci/sglang_benchmark_workflow.sh launch $model_name /models/Qwen/Qwen3-Next-80B-A3B-Instruct/ 4 1"
          elif [ "$model_name" == "Qwen3-Omni" ]; then
            docker exec sglang_test bash -c "scripts/ci/sglang_benchmark_workflow.sh launch $model_name /models/Qwen/Qwen3-Omni-30B-A3B-Instruct/ 4 1"
          else
            echo "Unknown model_name: ${model_name}"
            exit 1
          fi
      
      - name: Run vision model evaluation
        continue-on-error: true
        timeout-minutes: 60
        run: |
          model_name=${{ matrix.model }}
          if [ "$model_name" == "Qwen3-VL-235B" ]; then
            docker exec sglang_test bash -c "scripts/ci/sglang_benchmark_workflow.sh evaluation $model_name /models/RedHatAI/Qwen3-VL-235B-A22B-Instruct-FP8-dynamic/ 8 8"
          elif [ "$model_name" == "Qwen3-next" ]; then
            docker exec sglang_test bash -c "scripts/ci/sglang_benchmark_workflow.sh evaluation $model_name /models/Qwen/Qwen3-Next-80B-A3B-Instruct/ 4 1"
          elif [ "$model_name" == "Qwen3-Omni" ]; then
            docker exec sglang_test bash -c "scripts/ci/sglang_benchmark_workflow.sh evaluation $model_name /models/Qwen/Qwen3-Omni-30B-A3B-Instruct/ 4 1"
          else
            echo "Unknown model_name: ${model_name}"
            exit 1
          fi

      - name: Clean Up
        if: always()
        run:
          docker exec -u root sglang_test bash -c "rm -rf /sglang-checkout"

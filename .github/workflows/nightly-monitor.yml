name: Nightly Test Monitor

on:
  schedule:
    - cron: '0 8 * * *' # Run daily at 8 AM UTC (after nightly tests typically complete)
  workflow_dispatch:
    inputs:
      days:
        description: 'Number of days to analyze'
        required: false
        default: '7'
        type: string

concurrency:
  group: nightly-monitor-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: read
  issues: write

jobs:
  nightly-monitor:
    if: github.repository == 'sgl-project/sglang' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run Nightly Test Monitor
        id: monitor
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT_FOR_NIGHTLY_CI_DATA }}
          PYTHONUNBUFFERED: 1
          PYTHONIOENCODING: utf-8
        run: |
          cd scripts/ci_monitor
          python ci_analyzer.py \
            --token $GITHUB_TOKEN \
            --mode nightly \
            --days ${{ inputs.days || '7' }} \
            --output nightly_monitor_$(date +%Y%m%d_%H%M%S).json
        continue-on-error: true

      - name: Upload Monitor Results
        uses: actions/upload-artifact@v4
        with:
          name: nightly-monitor-results-${{ github.run_number }}
          path: |
            scripts/ci_monitor/nightly_monitor_*.json
          retention-days: 90

      - name: Comment on Issues if Regressions Detected
        if: steps.monitor.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT_FOR_NIGHTLY_CI_DATA }}
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find the latest monitor output file
            const files = fs.readdirSync('scripts/ci_monitor')
              .filter(f => f.startsWith('nightly_monitor_') && f.endsWith('.json'))
              .sort()
              .reverse();

            if (files.length === 0) {
              console.log('No monitor output file found');
              return;
            }

            const filePath = path.join('scripts/ci_monitor', files[0]);
            const stats = JSON.parse(fs.readFileSync(filePath, 'utf8'));

            // Create a summary of regressions
            let regressionSummary = '## ⚠️ Nightly Test Regressions Detected\n\n';
            regressionSummary += `**Report Date:** ${new Date().toISOString().split('T')[0]}\n`;
            regressionSummary += `**Analysis Period:** Last ${{ inputs.days || '7' }} days\n\n`;
            regressionSummary += `### Summary\n`;
            regressionSummary += `- Total Runs: ${stats.total_runs}\n`;
            regressionSummary += `- Failed Runs: ${stats.failed_runs} (${(stats.failed_runs/Math.max(1,stats.total_runs)*100).toFixed(1)}%)\n\n`;

            regressionSummary += `### Jobs with High Failure Rates (>30%)\n\n`;
            regressionSummary += `| Job Name | Failure Rate | Failures/Total |\n`;
            regressionSummary += `|----------|--------------|----------------|\n`;

            let hasRegressions = false;
            for (const [jobName, jobStat] of Object.entries(stats.job_stats)) {
              if (jobStat.total > 0) {
                const failureRate = (jobStat.failure / jobStat.total) * 100;
                if (failureRate > 30) {
                  hasRegressions = true;
                  regressionSummary += `| ${jobName} | ${failureRate.toFixed(1)}% | ${jobStat.failure}/${jobStat.total} |\n`;
                }
              }
            }

            if (!hasRegressions) {
              console.log('No high failure rates found');
              return;
            }

            regressionSummary += `\n[View detailed monitor results](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;

            // Post as a comment on a tracking issue or create a new one
            // For now, just log it (you can modify to create/update issues)
            console.log(regressionSummary);
            core.setOutput('regression_summary', regressionSummary);

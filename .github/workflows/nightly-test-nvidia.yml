name: Nightly Test (Nvidia)

on:
  schedule:
    - cron: '0 0 * * *'
  push:
    branches:
      - main
      - feat/nightly-test-naming-conventions  # TEMPORARY: for testing workflows before merge
    paths:
      - "python/sglang/version.py"
      - ".github/workflows/nightly-test-*.yml"  # TEMPORARY: trigger on workflow changes
  workflow_dispatch:

concurrency:
  group: nightly-test-nvidia-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Text model accuracy tests
  nightly-test-text-accuracy-2-gpu-runner:
    if: github.repository == 'sgl-project/sglang'
    uses: ./.github/workflows/nightly-test-text-accuracy-2-gpu-runner.yml
    secrets: inherit

  # Text model performance tests
  nightly-test-text-perf-2-gpu-runner:
    if: github.repository == 'sgl-project/sglang'
    uses: ./.github/workflows/nightly-test-text-perf-2-gpu-runner.yml
    secrets: inherit

  # VLM accuracy tests
  nightly-test-vlm-accuracy-2-gpu-runner:
    if: github.repository == 'sgl-project/sglang'
    uses: ./.github/workflows/nightly-test-vlm-accuracy-2-gpu-runner.yml
    secrets: inherit

  # VLM performance tests
  nightly-test-vlm-perf-2-gpu-runner:
    if: github.repository == 'sgl-project/sglang'
    uses: ./.github/workflows/nightly-test-vlm-perf-2-gpu-runner.yml
    secrets: inherit

  # Single GPU tests
  nightly-test-general-1-gpu-runner:
    if: github.repository == 'sgl-project/sglang'
    uses: ./.github/workflows/nightly-test-general-1-gpu-runner.yml
    secrets: inherit

  # 4 GPU tests
  nightly-test-general-4-gpu-h100:
    if: github.repository == 'sgl-project/sglang'
    uses: ./.github/workflows/nightly-test-general-4-gpu-h100.yml
    secrets: inherit

  # 8 GPU H200 tests
  nightly-test-general-8-gpu-h200:
    if: github.repository == 'sgl-project/sglang'
    uses: ./.github/workflows/nightly-test-general-8-gpu-h200.yml
    secrets: inherit

  # 8 GPU H20 tests
  nightly-test-general-8-gpu-h20:
    if: github.repository == 'sgl-project/sglang'
    uses: ./.github/workflows/nightly-test-general-8-gpu-h20.yml
    secrets: inherit

  # B200 GPU tests
  nightly-test-perf-4-gpu-b200:
    if: github.repository == 'sgl-project/sglang'
    uses: ./.github/workflows/nightly-test-perf-4-gpu-b200.yml
    secrets: inherit

  nightly-test-perf-8-gpu-b200:
    if: github.repository == 'sgl-project/sglang'
    uses: ./.github/workflows/nightly-test-perf-8-gpu-b200.yml
    secrets: inherit

  # Final check job
  check-all-jobs:
    if: github.repository == 'sgl-project/sglang' && always()
    needs:
      - nightly-test-text-accuracy-2-gpu-runner
      - nightly-test-text-perf-2-gpu-runner
      - nightly-test-vlm-accuracy-2-gpu-runner
      - nightly-test-vlm-perf-2-gpu-runner
      - nightly-test-general-1-gpu-runner
      - nightly-test-general-4-gpu-h100
      - nightly-test-general-8-gpu-h200
      - nightly-test-general-8-gpu-h20
      - nightly-test-perf-4-gpu-b200
      - nightly-test-perf-8-gpu-b200
    runs-on: ubuntu-latest
    steps:
      - name: Check if any job failed
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "One or more nightly test jobs failed"
            exit 1
          fi
          if [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "One or more nightly test jobs were cancelled"
            exit 1
          fi
          echo "All nightly test jobs passed"

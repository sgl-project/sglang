name: Release PyPI Nightly Wheels

on:
  # Triggered by nightly Docker workflow to use same commit
  repository_dispatch:
    types: [nightly-release]
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Specific commit SHA to build (leave empty for latest)'
        required: false
        type: string

concurrency:
  group: release-pypi-nightly-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-nightly-wheel:
    if: github.repository == 'sgl-project/sglang'
    runs-on: ubuntu-latest
    outputs:
      nightly_version: ${{ steps.gen_version.outputs.nightly_version }}
      commit_hash: ${{ steps.gen_version.outputs.commit_hash }}
    steps:
      - uses: actions/checkout@v4
        with:
          # Use commit from: 1) Docker workflow, 2) manual input, 3) latest main
          ref: ${{ github.event.client_payload.commit_sha || inputs.commit_sha || github.sha }}
          fetch-depth: 0  # Need full history for version generation

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Generate nightly version
        id: gen_version
        run: |
          # Get base version from version.py
          BASE_VERSION=$(cat python/sglang/version.py | cut -d'"' -f2)

          # Get commit info
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_COUNT=$(git rev-list --count HEAD)

          # Generate nightly version following PEP 440
          # Format: {base_version}.dev{commit_count}+g{commit_hash}
          NIGHTLY_VERSION="${BASE_VERSION}.dev${COMMIT_COUNT}+g${COMMIT_HASH}"

          echo "Base version: ${BASE_VERSION}"
          echo "Nightly version: ${NIGHTLY_VERSION}"
          echo "Commit: ${COMMIT_HASH}"

          echo "nightly_version=${NIGHTLY_VERSION}" >> $GITHUB_OUTPUT
          echo "commit_hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "base_version=${BASE_VERSION}" >> $GITHUB_OUTPUT

      - name: Update pyproject.toml with nightly version
        run: |
          cd python
          BASE_VERSION=$(cat sglang/version.py | cut -d'"' -f2)
          NIGHTLY_VERSION="${{ steps.gen_version.outputs.nightly_version }}"

          # IMPORTANT: This modification is TEMPORARY and only exists in the CI runner.
          # We are NOT committing this change back to the repo.
          # The stable pyproject.toml in the repo remains unchanged.
          # This is just so `python -m build` creates a wheel with the nightly version.

          # Update version (temporary, not committed)
          sed -i "s/version = \"${BASE_VERSION}\"/version = \"${NIGHTLY_VERSION}\"/" pyproject.toml

          # Verify update
          echo "Updated version in pyproject.toml:"
          grep "^version" pyproject.toml

      - name: Install build dependencies
        run: |
          cd python
          pip install build wheel setuptools

      - name: Build wheel
        run: |
          cd python
          cp ../README.md ../LICENSE .
          python3 -m build --wheel

          # List built wheels
          echo "Built wheel:"
          ls -lh dist/

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: nightly-wheel
          path: python/dist/*.whl
          retention-days: 7

  release-nightly:
    needs: build-nightly-wheel
    runs-on: ubuntu-latest
    environment: 'prod'
    steps:
      - uses: actions/checkout@v4

      - name: Download wheel artifact
        uses: actions/download-artifact@v4
        with:
          name: nightly-wheel
          path: dist/

      - name: List downloaded wheels
        run: |
          echo "Downloaded wheel:"
          ls -lh dist/

      - name: Create GitHub Release for nightly wheel
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly-${{ needs.build-nightly-wheel.outputs.commit_hash }}
          name: Nightly Build (${{ needs.build-nightly-wheel.outputs.commit_hash }})
          repository: sgl-project/whl
          token: ${{ secrets.GH_PAT_FOR_WHL_RELEASE }}
          prerelease: true
          body: |
            Nightly build from commit ${{ github.sha }}
            Version: ${{ needs.build-nightly-wheel.outputs.nightly_version }}

            ## Installation

            **Quick install (uses default CUDA 12.9):**
            ```bash
            pip install sglang --extra-index-url https://sgl-project.github.io/whl/nightly/
            ```

            **For specific CUDA versions:**
            ```bash
            # CUDA 12.9
            pip install sglang \
              --extra-index-url https://sgl-project.github.io/whl/nightly/ \
              --extra-index-url https://sgl-project.github.io/whl/cu129/sgl-kernel/

            # CUDA 13.0
            pip install sglang \
              --extra-index-url https://sgl-project.github.io/whl/nightly/ \
              --extra-index-url https://sgl-project.github.io/whl/cu130/sgl-kernel/
            ```

            **Note:** This is a pure Python wheel that works on all platforms (x86_64, aarch64, Windows, macOS, Linux).
            CUDA version and architecture are selected via dependencies (sgl-kernel).

            Or install directly:
            ```bash
            pip install https://github.com/sgl-project/whl/releases/download/nightly-${{ needs.build-nightly-wheel.outputs.commit_hash }}/sglang-${{ needs.build-nightly-wheel.outputs.nightly_version }}-py3-none-any.whl
            ```
          files: |
            dist/*.whl

      - name: Clone wheel index repository
        run: |
          git clone https://oauth2:${WHL_TOKEN}@github.com/sgl-project/whl.git sgl-whl
          cd sgl-whl
          git config --local user.name "sglang-bot"
          git config --local user.email "sglangbot@gmail.com"
        env:
          WHL_TOKEN: ${{ secrets.GH_PAT_FOR_WHL_RELEASE }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Update wheel index
        run: |
          python3 scripts/update_nightly_whl_index.py \
            --commit-hash ${{ needs.build-nightly-wheel.outputs.commit_hash }} \
            --nightly-version ${{ needs.build-nightly-wheel.outputs.nightly_version }}

      - name: Push wheel index
        run: |
          cd sgl-whl
          git add -A
          git diff --staged --quiet || git commit -m "Update nightly wheel index for commit ${{ needs.build-nightly-wheel.outputs.commit_hash }}"
          git push

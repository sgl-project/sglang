name: Release Gateway Crate to crates.io

on:
  push:
    branches:
      - main
    paths:
      - sgl-model-gateway/Cargo.toml
  workflow_dispatch:

jobs:
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- Linux x86_64 ---
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            linker: ""
            is_cross: false

          # --- Linux ARM64 (åŸç”Ÿ Cargo + äº¤å‰å·¥å…·é“¾) ---
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            linker: "aarch64-linux-gnu-gcc"
            is_cross: true

          # --- macOS x86_64 ---
          - os: macos-latest
            target: x86_64-apple-darwin
            linker: ""
            is_cross: false

          # --- macOS ARM64 ---
          - os: macos-latest
            target: aarch64-apple-darwin
            linker: ""
            is_cross: false

          # --- Windows x86_64 ---
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            linker: ""
            is_cross: false

    steps:
      - uses: actions/checkout@v4
        with:
          path: sglang-repo

      - name: Prepare source code
        shell: bash
        run: |
          mv sglang-repo/sgl-model-gateway/* .
          rm -rf sglang-repo
          ls -alt

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # -------------------------------------------------------------
      # 1. å®‰è£… Linux ç¼–è¯‘ä¾èµ– (ç§»æ¤è‡ªä½ çš„è„šæœ¬)
      # åŒ…æ‹¬: perl, make, gcc (åŸºç¡€), gcc-aarch64 (äº¤å‰), protoc
      # -------------------------------------------------------------
      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -e
          echo "Installing base dependencies..."
          sudo apt-get update
          # å®‰è£…åŸºç¡€æ„å»ºå·¥å…· (OpenSSL éœ€è¦ perl/make, é€šç”¨ç¼–è¯‘éœ€è¦ gcc/g++)
          sudo apt-get install -y wget unzip gcc g++ perl make

          # å¦‚æœæ˜¯ ARM64 ç›®æ ‡ï¼Œå®‰è£…äº¤å‰ç¼–è¯‘å™¨
          if [ "${{ matrix.is_cross }}" == "true" ]; then
            echo "Installing ARM64 cross-compilation toolchain..."
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          fi

          # --- æ‰‹åŠ¨å®‰è£… Proto
          echo "Downloading and installing Protoc v32.0..."

          (cd /tmp && \
           wget https://github.com/protocolbuffers/protobuf/releases/download/v32.0/protoc-32.0-linux-x86_64.zip && \
           sudo unzip -o protoc-32.0-linux-x86_64.zip -d /usr/local && \
           rm protoc-32.0-linux-x86_64.zip)

          protoc --version

      # -------------------------------------------------------------
      # 2. å®‰è£… macOS/Windows ä¾èµ–
      # -------------------------------------------------------------
      - name: Install Dependencies (Mac/Win)
        if: runner.os != 'Linux'
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "macOS" ]; then
            brew install protobuf
          elif [ "$RUNNER_OS" == "Windows" ]; then
            choco install protoc
            if [ ! -f "C:/Strawberry/perl/bin/perl.exe" ]; then
              echo "Warning: Strawberry Perl not found!"
            fi
          fi

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

      # -------------------------------------------------------------
      # 3. ç¼–è¯‘ (Cargo Build)
      # -------------------------------------------------------------
      - name: Build Binary
        shell: bash
        env:
          # å°† LTO ä» "fat" é™çº§ä¸º "thin" (å†…å­˜å ç”¨å¤§å¹…é™ä½ï¼Œæ€§èƒ½å‡ ä¹æ— æŸ)
          CARGO_PROFILE_RELEASE_LTO: "thin"
          # å¢åŠ ä»£ç ç”Ÿæˆå•å…ƒ (å…è®¸å¹¶è¡Œå¤„ç†ï¼Œé™ä½å•ä¸ªå•å…ƒçš„å†…å­˜å³°å€¼)
          CARGO_PROFILE_RELEASE_CODEGEN_UNITS: 16
        # -----------------------------------------------
        run: |
          # 1. é’ˆå¯¹ Linux ARM64: è®¾ç½®é“¾æ¥å™¨
          if [ -n "${{ matrix.linker }}" ]; then
            if [ "${{ matrix.target }}" == "aarch64-unknown-linux-gnu" ]; then
              export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=${{ matrix.linker }}
            fi
            echo "Set linker to ${{ matrix.linker }}"
          fi

          # 2. é’ˆå¯¹ Windows: å¼ºåˆ¶ä½¿ç”¨ Strawberry Perl
          if [ "$RUNNER_OS" == "Windows" ]; then
             export PERL="C:/Strawberry/perl/bin/perl.exe"
          fi

          echo "ğŸ—ï¸ Building with CARGO for ${{ matrix.target }}..."

          # æ‰§è¡Œç¼–è¯‘:
          # å¼ºåˆ¶å¼€å¯ vendored-openssl ä»¥ç”Ÿæˆé™æ€é“¾æ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶
          cargo build --release --target ${{ matrix.target }} --features vendored-openssl

      # -------------------------------------------------------------
      # 4. æ‰“åŒ…ä¸ä¸Šä¼ 
      # -------------------------------------------------------------
      - name: Package binaries
        shell: bash
        run: |
          set -e
          ARTIFACT_NAME="${{ matrix.target }}"
          OUT_DIR="${{ github.workspace }}/artifacts/$ARTIFACT_NAME"
          mkdir -p "$OUT_DIR"
          BIN_DIR="target/${{ matrix.target }}/release"

          if [[ "${{ matrix.target }}" == *"windows"* ]]; then EXT=".exe"; else EXT=""; fi

          for bin in sgl-model-gateway smg amg; do
            if [ -f "$BIN_DIR/$bin$EXT" ]; then
              cp "$BIN_DIR/$bin$EXT" "$OUT_DIR/"
            else
               echo "Warning: $bin binary not found in $BIN_DIR"
            fi
          done

          cp LICENSE "$OUT_DIR/" 2>/dev/null || true
          cp README.md "$OUT_DIR/" 2>/dev/null || true

          cd "${{ github.workspace }}/artifacts"
          tar -czf "$ARTIFACT_NAME.tar.gz" "$ARTIFACT_NAME"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sgl-model-gateway-${{ matrix.os }}-${{ matrix.target }}
          path: artifacts/*.tar.gz

  # Publish Job
  publish:
    name: Publish to crates.io
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.ref == 'refs/heads/main' && github.event_name == 'push')

    steps:
      - uses: actions/checkout@v4
        with:
          path: sglang-repo

      # 1. ä¿®å¤æ–‡ä»¶ç»“æ„ & ä¿®å¤ LICENSE è½¯é“¾æ¥
      - name: Move sgl-model-gateway folder and Fix LICENSE
        run: |
          mv sglang-repo/sgl-model-gateway/* .
          # åˆ é™¤æ–­æ‰çš„è½¯é“¾æ¥ï¼Œå¤åˆ¶çœŸå®æ–‡ä»¶
          rm LICENSE
          cp sglang-repo/LICENSE .
          rm -rf sglang-repo
          ls -al

      # 2. å®‰è£…ä¾èµ– & æ‰‹åŠ¨å®‰è£… Protoc v32.0 (ä¿æŒä¸ Build ä¸€è‡´)
      - name: Install Dependencies & Protoc
        shell: bash
        run: |
          set -e
          echo "Installing base dependencies..."
          sudo apt-get update
          # å®‰è£…åŸºç¡€æ„å»ºå·¥å…·
          sudo apt-get install -y wget unzip gcc g++ perl make

          # --- æ‰‹åŠ¨å®‰è£… Protoc v32.0
          echo "Downloading and installing Protoc v32.0..."
          (cd /tmp && \
           wget https://github.com/protocolbuffers/protobuf/releases/download/v32.0/protoc-32.0-linux-x86_64.zip && \
           sudo unzip -o protoc-32.0-linux-x86_64.zip -d /usr/local && \
           rm protoc-32.0-linux-x86_64.zip)

          protoc --version

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      # 3. å‘å¸ƒ
      - name: Publish crate (Dry Run)
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          # è°ƒè¯•ç”¨ --dry-runï¼Œæ­£å¼å‘å¸ƒè¯·å»æ‰
          cargo publish --dry-run --token "$CARGO_REGISTRY_TOKEN"

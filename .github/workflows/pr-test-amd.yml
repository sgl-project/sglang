name: PR Test (AMD)
# Dynamic run-name for /rerun-stage commands to enable URL lookup
# Format: "[stage-name] sha" for fork PRs, "[stage-name]" for non-fork, default for normal runs
run-name: ${{ inputs.target_stage && (inputs.pr_head_sha && format('[{0}] {1}', inputs.target_stage, inputs.pr_head_sha) || format('[{0}]', inputs.target_stage)) || '' }}

on:
  push:
    branches: [ main ]
    paths:
      - "python/**"
      - "scripts/ci/**"
      - "test/**"
      - "sgl-kernel/**"
      - ".github/workflows/pr-test-amd.yml"
      - "docker/rocm.Dockerfile"
  pull_request:
    branches: [ main ]
    paths:
      - "python/**"
      - "scripts/ci/**"
      - "test/**"
      - "sgl-kernel/**"
      - ".github/workflows/pr-test-amd.yml"
      - "docker/rocm.Dockerfile"
  workflow_dispatch:
    inputs:
      target_stage:
        description: "Specific stage to run (optional, for quick testing)"
        required: false
        type: string
        default: ""
      pr_head_sha:
        description: "PR head SHA to checkout (for /rerun-stage on fork PRs)"
        required: false
        type: string
        default: ""
  workflow_call:
    inputs:
      ref:
        description: 'Git ref (branch, tag, or SHA) to test. If not provided, uses the default branch.'
        required: false
        type: string
        default: ''
      run_all_tests:
        description: "Run all tests (for releasing or testing purpose)"
        required: false
        type: boolean
        default: false

concurrency:
  # Include pr_head_sha in group for /rerun-stage dispatches to avoid collisions with main branch runs
  group: pr-test-amd-${{ inputs.pr_head_sha || inputs.ref || github.ref }}
  cancel-in-progress: ${{ github.event_name != 'workflow_call' }}

jobs:
  call-gate:
    uses: ./.github/workflows/pr-gate.yml
    secrets: inherit
  check-changes:
    needs: [call-gate]
    runs-on: ubuntu-latest
    outputs:
      main_package: ${{ steps.filter.outputs.main_package || steps.run-mode.outputs.run_all_tests }}
      sgl_kernel: ${{ steps.filter.outputs.sgl_kernel || steps.run-mode.outputs.run_all_tests }}
      multimodal_gen: ${{ steps.filter.outputs.multimodal_gen || steps.run-mode.outputs.run_all_tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.pr_head_sha || inputs.ref || github.sha }}

      - name: Determine run mode
        id: run-mode
        run: |
          # Run all tests for workflow_call (when ref input is provided)
          # Note: github.event_name is inherited from caller, so we detect workflow_call by checking inputs.ref
          if [[ "${{ inputs.run_all_tests }}" == "true" ]]; then
            echo "run_all_tests=true" >> $GITHUB_OUTPUT
            echo "Run mode: ALL TESTS (run_all_tests=${{ inputs.run_all_tests }})"
          else
            echo "run_all_tests=false" >> $GITHUB_OUTPUT
            echo "Run mode: FILTERED (triggered by ${{ github.event_name }})"
          fi

      - name: Detect file changes
        id: filter
        uses: dorny/paths-filter@v3
        if: steps.run-mode.outputs.run_all_tests != 'true'
        with:
          filters: |
            main_package:
              - "python/sglang/!(multimodal_gen)/**"
              - "python/pyproject_rocm.toml"
              - "python/pyproject_other.toml"
              - "scripts/ci/amd/*"
              - "scripts/ci/utils/*"
              - "test/**"
              - ".github/workflows/pr-test-amd.yml"
            sgl_kernel:
              - "sgl-kernel/**"
              - ".github/workflows/pr-test-amd.yml"
              # Exclude non-ROCm platform configs and code
              - "!sgl-kernel/pyproject_cpu.toml"
              - "!sgl-kernel/pyproject.toml"
              - "!sgl-kernel/pyproject_musa.toml"
              - "!sgl-kernel/setup_musa.py"
              - "!sgl-kernel/csrc/cpu/**"
              # Exclude documentation and non-functional files
              - "!sgl-kernel/README.md"
              - "!sgl-kernel/LICENSE"
              - "!sgl-kernel/THIRDPARTYNOTICES.txt"
              - "!sgl-kernel/.clang-format"
              - "!sgl-kernel/analyze_whl_kernel_sizes.py"
              - "!sgl-kernel/rename_wheels.sh"
            multimodal_gen:
              - "python/sglang/multimodal_gen/**"
              - "python/sglang/cli/**"
              - "python/pyproject_rocm.toml"
              - "python/pyproject_other.toml"

  # stage-c-test-large-8-gpu-amd-mi35x:
  #   needs: [check-changes, call-gate, stage-b-test-small-1-gpu-amd, stage-b-test-large-2-gpu-amd]
  #   if: |
  #     always() &&
  #     (
  #       (inputs.target_stage == 'stage-c-test-large-8-gpu-amd-mi35x') ||
  #       (
  #         !inputs.target_stage &&
  #         (!failure() && !cancelled()) &&
  #         ((needs.check-changes.outputs.main_package == 'true') || (needs.check-changes.outputs.sgl_kernel == 'true'))
  #       )
  #     )
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       runner: [linux-mi35x-gpu-8]
  #       part: [0]
  #   runs-on: ${{matrix.runner}}
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #       with:
  #         ref: ${{ inputs.pr_head_sha || inputs.ref || github.sha }}

  #     - name: Ensure VRAM is clear
  #       run: bash scripts/ensure_vram_clear.sh rocm

  #     - name: Start CI container
  #       run: bash scripts/ci/amd/amd_ci_start_container.sh
  #       env:
  #         GITHUB_WORKSPACE: ${{ github.workspace }}

  #     - name: Install dependencies
  #       run: bash scripts/ci/amd/amd_ci_install_dependency.sh

  #     - name: Run test
  #       timeout-minutes: 60
  #       run: |
  #         bash scripts/ci/amd/amd_ci_exec.sh -w "/sglang-checkout/test" python3 run_suite.py --hw amd --suite stage-c-test-large-8-gpu-amd-mi35x --auto-partition-id ${{ matrix.part }} --auto-partition-size 1 --timeout-per-file 3600

  check-pdd-env:
    runs-on: linux-mi35x-gpu-8.fabric
    steps:
      - name: Find RDMA in CI Runner
        run: |
          set +e

          echo ""
          echo "=== 0. Checking standard path for Ionic driver ==="
          ls -l /usr/lib/x86_64-linux-gnu/libibverbs/libionic* 2>/dev/null || echo "libionic not found in standard path"

          echo ""
          echo "=== 0a. Resolve symlink and check actual library file ==="
          IONIC_SYMLINK="/usr/lib/x86_64-linux-gnu/libibverbs/libionic-rdmav34.so"
          if [[ -L "$IONIC_SYMLINK" ]]; then
            IONIC_REAL=$(readlink -f "$IONIC_SYMLINK" 2>/dev/null)
            echo "Symlink: $IONIC_SYMLINK"
            echo "Points to: $IONIC_REAL"
            if [[ -f "$IONIC_REAL" ]]; then
              echo "Actual library EXISTS:"
              ls -la "$IONIC_REAL"
            else
              echo "ERROR: Actual library file does NOT exist (broken symlink)!"
            fi
          else
            echo "Symlink $IONIC_SYMLINK does not exist"
          fi

          echo ""
          echo "=== 0b. Check libionic.so.* directly ==="
          ls -la /usr/lib/x86_64-linux-gnu/libionic* 2>/dev/null || echo "No libionic.so.* files in /usr/lib/x86_64-linux-gnu/"

          echo ""
          echo "=== 0c. Deep search for libionic-rdmav34.so ==="
          find /usr /lib /opt -name "libionic-rdmav34.so" 2>/dev/null || echo "libionic-rdmav34.so not found anywhere"

          echo ""
          echo "=== 0d. Search for any ionic related libraries ==="
          find /usr /lib /opt -name "*libionic*" 2>/dev/null || echo "No ionic related files found"

          echo ""
          echo "=== 1. libibverbs provider configs ==="
          find /etc -name "*.driver" 2>/dev/null || true
          ls -la /etc/libibverbs.d/ 2>/dev/null || echo "/etc/libibverbs.d not found"

          echo ""
          echo "=== 2. Provider libraries ==="
          find /usr/lib -name "*verbs*.so*" 2>/dev/null || true
          find /usr/lib64 -name "*verbs*.so*" 2>/dev/null || true
          ls -la /usr/lib/x86_64-linux-gnu/libibverbs/ 2>/dev/null || echo "Standard libibverbs path not found"

          echo ""
          echo "=== 3. ionic related ==="
          find /usr -name "*ionic*" 2>/dev/null || echo "No ionic files found"

          echo ""
          echo "=== 4. libibverbs.d directory search ==="
          find / -name "libibverbs.d" -type d 2>/dev/null || echo "Not found anywhere"

          echo ""
          echo "=== 5. ldconfig cache ==="
          ldconfig -p 2>/dev/null | grep -i verbs || echo "No verbs in ldconfig"

          echo ""
          echo "=== 6. Installed packages ==="
          dpkg -l 2>/dev/null | grep -E "rdma|verbs|infiniband" || rpm -qa 2>/dev/null | grep -E "rdma|verbs" || echo "Package manager check failed"

          echo ""
          echo "=== 7. /dev/infiniband ==="
          ls -la /dev/infiniband/ 2>/dev/null || echo "/dev/infiniband not found"

          echo ""
          echo "=== 8. /sys/class/infiniband ==="
          ls -la /sys/class/infiniband/ 2>/dev/null || echo "Not found"

          echo ""
          echo "=== 9. /sys/class/infiniband_verbs ==="
          ls -la /sys/class/infiniband_verbs/ 2>/dev/null || echo "Not found"

          echo ""
          echo "=== 10. ibv_devinfo ==="
          which ibv_devinfo 2>/dev/null || echo "ibv_devinfo not in PATH"
          ibv_devinfo 2>&1 || echo "ibv_devinfo failed or not found"

          echo ""
          echo "=== 11. Kernel modules ==="
          lsmod 2>/dev/null | grep -E "ib_|rdma|ionic" || echo "lsmod failed or no modules"

          echo ""
          echo "=== Check Complete ==="


  # =============================================== Disaggregation ====================================================
  stage-b-test-large-2-gpu-35x-fabric-disaggregation-amd:
    needs: [check-changes]
    if: |
      always() &&
      (
        (inputs.target_stage == 'stage-b-test-large-2-gpu-disaggregation-amd') ||
        (
          !inputs.target_stage &&
          (!failure() && !cancelled()) &&
          ((needs.check-changes.outputs.main_package == 'true') || (needs.check-changes.outputs.sgl_kernel == 'true'))
        )
      )
    strategy:
      fail-fast: false
      matrix:
        runner: [linux-mi35x-gpu-8.fabric]
        part: [0]

    runs-on: ${{matrix.runner}}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.pr_head_sha || inputs.ref || github.sha }}

      - name: Ensure VRAM is clear
        run: bash scripts/ensure_vram_clear.sh rocm

      - name: Detect RDMA Devices
        id: rdma_detect
        run: |
          if [ -d "/sys/class/infiniband" ]; then
            RDMA_DEVS=$(ls /sys/class/infiniband | paste -sd "," -)
            echo "Detected RDMA Devices: $RDMA_DEVS"
            echo "SGLANG_TEST_RDMA_DEVICE=$RDMA_DEVS" >> $GITHUB_ENV
          else
            echo "No RDMA devices found in /sys/class/infiniband"
            echo "SGLANG_TEST_RDMA_DEVICE=" >> $GITHUB_ENV
          fi

      - name: Start Special Container
        run: bash scripts/ci/amd/amd_ci_start_container_disagg.sh
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}

      - name: Install dependencies
        run: bash scripts/ci/amd/amd_ci_install_dependency.sh

      # - name: Debug RDMA Driver Dependencies
      #   run: |
      #     echo "=== Debugging Ionic Driver Dependencies ==="
      #     echo "Checking what libraries libionic-rdmav34.so is missing..."
      #     docker exec ci_sglang ldd /usr/lib/x86_64-linux-gnu/libibverbs/libionic-rdmav34.so

      - name: Setup RDMA in Container
        run: |
          echo "=== Verify RDMA in container ==="
          docker exec -u root ci_sglang bash -c '
            echo "=== Verification ==="
            ibv_devinfo -list
            echo "Device nodes:"
            ls -la /dev/infiniband/
            echo ""
            echo "Driver config:"
            cat /etc/libibverbs.d/ionic.driver 2>/dev/null || echo "No ionic.driver config"
            echo ""
            echo "Provider libraries:"
            ls /usr/lib/x86_64-linux-gnu/libibverbs/ | grep -E "ionic|mlx" || echo "No Ionic/Mellanox providers"
            echo ""
            echo "ibv_devinfo:"
            ibv_devinfo -list

            # Verify HCAs are detected
            HCA_COUNT=$(ibv_devinfo -list 2>&1 | grep -oE "^[0-9]+ HCAs? found" | grep -oE "^[0-9]+" || echo "0")
            if [ "$HCA_COUNT" -gt 0 ]; then
              echo ""
              echo "=== SUCCESS: RDMA setup complete. Found $HCA_COUNT HCA(s) ==="
            else
              echo ""
              echo "=== WARNING: No HCAs detected. RDMA tests may fail ==="
            fi
          '

      - name: Run Aiter Op Test (RMSNorm)
        timeout-minutes: 10
        run: |
          echo "Running pre-check: test_rmsnorm2d.py"
          docker exec \
            -e MAX_JOBS=192 \
            ci_sglang \
            python /sgl-workspace/aiter/op_tests/test_rmsnorm2d.py

      - name: Run test_disaggregation_basic
        timeout-minutes: 60
        run: |
          bash scripts/ci/amd/amd_ci_exec.sh \
            -e SGLANG_TEST_RDMA_DEVICE="${{ env.SGLANG_TEST_RDMA_DEVICE }}" \
            -w "/sglang-checkout/test" python3 run_suite.py --hw amd --suite stage-b-test-large-2-gpu-35x-disaggregation-amd --auto-partition-id ${{ matrix.part }} --auto-partition-size 1 --timeout-per-file 3600

  stage-b-test-large-8-gpu-35x-fabric-disaggregation-amd:
    needs: [check-changes]
    if: |
      always() &&
      (
        (inputs.target_stage == 'stage-b-test-large-8-gpu-disaggregation-amd') ||
        (
          !inputs.target_stage &&
          (!failure() && !cancelled()) &&
          ((needs.check-changes.outputs.main_package == 'true') || (needs.check-changes.outputs.sgl_kernel == 'true'))
        )
      )
    strategy:
      fail-fast: false
      matrix:
        runner: [linux-mi35x-gpu-8.fabric]
        part: [0]

    runs-on: ${{matrix.runner}}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.pr_head_sha || inputs.ref || github.sha }}

      - name: Ensure VRAM is clear
        run: bash scripts/ensure_vram_clear.sh rocm

      - name: Detect RDMA Devices
        id: rdma_detect
        run: |
          if [ -d "/sys/class/infiniband" ]; then
            RDMA_DEVS=$(ls /sys/class/infiniband | paste -sd "," -)
            echo "Detected RDMA Devices: $RDMA_DEVS"
            echo "SGLANG_TEST_RDMA_DEVICE=$RDMA_DEVS" >> $GITHUB_ENV
          else
            echo "No RDMA devices found in /sys/class/infiniband"
            echo "SGLANG_TEST_RDMA_DEVICE=" >> $GITHUB_ENV
          fi

      - name: Start Special Container
        run: bash scripts/ci/amd/amd_ci_start_container_disagg.sh
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}

      - name: Install dependencies
        run: bash scripts/ci/amd/amd_ci_install_dependency.sh

      - name: Setup RDMA in Container
        run: |
          echo "=== Verify RDMA in container ==="
          docker exec -u root ci_sglang bash -c '
            echo "=== Verification ==="
            echo "Device nodes:"
            ls -la /dev/infiniband/
            echo ""
            echo "Driver config:"
            cat /etc/libibverbs.d/ionic.driver 2>/dev/null || echo "No ionic.driver config"
            echo ""
            echo "Provider libraries:"
            ls /usr/lib/x86_64-linux-gnu/libibverbs/ | grep -E "ionic|mlx" || echo "No Ionic/Mellanox providers"
            echo ""
            echo "ibv_devinfo:"
            ibv_devinfo -list

            # Verify HCAs are detected
            HCA_COUNT=$(ibv_devinfo -list 2>&1 | grep -oE "^[0-9]+ HCAs? found" | grep -oE "^[0-9]+" || echo "0")
            if [ "$HCA_COUNT" -gt 0 ]; then
              echo ""
              echo "=== SUCCESS: RDMA setup complete. Found $HCA_COUNT HCA(s) ==="
            else
              echo ""
              echo "=== WARNING: No HCAs detected. RDMA tests may fail ==="
            fi
          '

      - name: Run Aiter Op Test (RMSNorm)
        timeout-minutes: 10
        run: |
          echo "Running pre-check: test_rmsnorm2d.py"
          docker exec \
            -e MAX_JOBS=192 \
            ci_sglang \
            python /sgl-workspace/aiter/op_tests/test_rmsnorm2d.py

      - name: Run test_disaggregation_pp
        timeout-minutes: 60
        run: |
          bash scripts/ci/amd/amd_ci_exec.sh \
            -e SGLANG_TEST_RDMA_DEVICE="${{ env.SGLANG_TEST_RDMA_DEVICE }}" \
            -w "/sglang-checkout/test" python3 run_suite.py --hw amd --suite stage-b-test-large-8-gpu-35x-disaggregation-amd --auto-partition-id ${{ matrix.part }} --auto-partition-size 1 --timeout-per-file 3600

      # - name: Run test_disaggregation_pp
      #   timeout-minutes: 15
      #   run: |
      #     bash scripts/ci/amd_ci_exec.sh \
      #       -e SGLANG_TEST_RDMA_DEVICE="${{ env.SGLANG_TEST_RDMA_DEVICE }}" \
      #       python3 -m unittest test/registered/amd/disaggregation/test_disaggregation_pp.py

  # pr-test-amd-finish:
  #   needs:
  #     [
  #       call-gate,
  #       check-changes,

  #       # sgl-kernel-unit-test-amd,
  #       # sgl-kernel-unit-test-2-gpu-amd,
  #       # multimodal-gen-test-1-gpu-amd,
  #       # multimodal-gen-test-2-gpu-amd,

  #       # stage-a-test-1-amd,
  #       # stage-b-test-small-1-gpu-amd,
  #       # stage-b-test-small-1-gpu-amd-mi35x,
  #       # stage-b-test-large-1-gpu-amd,
  #       # stage-b-test-large-2-gpu-amd,
  #       # stage-c-test-large-8-gpu-amd,
  #       # stage-c-test-large-8-gpu-amd-mi35x,
  #     ]
  #   if: always()
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Check all dependent job statuses
  #       run: |
  #         # Convert the 'needs' context to a JSON string
  #         json_needs='${{ toJson(needs) }}'

  #         # Get a list of all job names from the JSON keys
  #         job_names=$(echo "$json_needs" | jq -r 'keys_unsorted[]')

  #         for job in $job_names; do
  #           # For each job, extract its result
  #           result=$(echo "$json_needs" | jq -r --arg j "$job" '.[$j].result')

  #           # Print the job name and its result
  #           echo "$job: $result"

  #           # Check for failure or cancellation and exit if found
  #           if [[ "$result" == "failure" || "$result" == "cancelled" ]]; then
  #             echo "The above jobs failed."
  #             exit 1
  #           fi
  #         done

  #         # If the loop completes, all jobs were successful
  #         echo "All jobs completed successfully"
  #         exit 0

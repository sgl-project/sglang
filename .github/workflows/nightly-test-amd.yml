name: Nightly Test (AMD)

on:
  schedule:
    - cron: '0 0 * * *'
  push:
    branches:
      - main
    paths:
      - "python/sglang/version.py"
  workflow_dispatch:

concurrency:
  group: nightly-test-amd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # AMD MI300 tests
  nightly-test-general-2-gpu-mi300:
    if: github.repository == 'sgl-project/sglang'
    uses: ./.github/workflows/nightly/nightly-test-general-2-gpu-mi300.yml
    secrets: inherit

  # AMD MI325 tests
  nightly-test-general-2-gpu-mi325:
    if: github.repository == 'sgl-project/sglang'
    uses: ./.github/workflows/nightly/nightly-test-general-2-gpu-mi325.yml
    secrets: inherit

  # Final check job
  check-all-jobs:
    if: github.repository == 'sgl-project/sglang' && always()
    needs:
      - nightly-test-general-2-gpu-mi300
      - nightly-test-general-2-gpu-mi325
    runs-on: ubuntu-latest
    steps:
      - name: Check if any job failed
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "One or more nightly test jobs failed"
            exit 1
          fi
          if [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "One or more nightly test jobs were cancelled"
            exit 1
          fi
          echo "All nightly test jobs passed"

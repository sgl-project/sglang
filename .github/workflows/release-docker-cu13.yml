name: Build and Push CUDA 13 Docker Images

# release this manually via workflow_dispatch for now
on:
    workflow_dispatch:
      inputs:
        pr_number:
          description: "PR number to build from (leave empty to use current branch)"
          required: false
          default: ""
        tag_suffix:
          description: "Custom tag suffix (e.g. 'pr-1234' produces dev-x86-cu13-pr-1234). Leave empty for default tags."
          required: false
          default: ""
    schedule:
      - cron: "0 0 * * *"
jobs:
    build-dev:
        if: ${{ github.repository == 'sgl-project/sglang' }}
        runs-on: ${{ matrix.runner }}
        strategy:
            matrix:
                include:
                    - runner: x64-docker-build-node
                      platform: linux/amd64
                      build_type: all
                      grace_blackwell: 0
                      tag: dev-x86-cu13
                      version: 13.0.1
                    - runner: arm-docker-build-node
                      platform: linux/arm64
                      build_type: all
                      grace_blackwell: 1
                      tag: dev-arm64-cu13
                      version: 13.0.1
        steps:
            - name: Delete huge unnecessary tools folder
              run: rm -rf /opt/hostedtoolcache

            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                ref: ${{ inputs.pr_number && format('refs/pull/{0}/head', inputs.pr_number) || github.ref }}

            - name: Free disk space
              uses: jlumbroso/free-disk-space@main
              with:
                  tool-cache: true
                  docker-images: true
                  android: true
                  dotnet: true
                  haskell: true
                  large-packages: true
                  swap-storage: true

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to Docker Hub
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build and Push Dev Image
              run: |
                  TAG=${{ matrix.tag }}
                  if [ -n "${{ inputs.tag_suffix }}" ]; then
                    TAG="${TAG}-${{ inputs.tag_suffix }}"
                  fi

                  docker buildx build \
                    --platform ${{ matrix.platform }} \
                    --push \
                    --target framework \
                    -f docker/Dockerfile \
                    --build-arg CUDA_VERSION=${{ matrix.version }} \
                    --build-arg BUILD_TYPE=${{ matrix.build_type }} \
                    --build-arg CMAKE_BUILD_PARALLEL_LEVEL=$(nproc) \
                    --build-arg GRACE_BLACKWELL=${{ matrix.grace_blackwell }} \
                    --build-arg BRANCH_TYPE=local \
                    --build-arg INSTALL_FLASHINFER_JIT_CACHE=1 \
                    -t lmsysorg/sglang:${TAG} \
                    --no-cache \
                    .

    create-manifests:
        runs-on: ubuntu-22.04
        needs: [build-dev]
        if: ${{ github.repository == 'sgl-project/sglang' }}
        strategy:
            matrix:
                variant:
                    - tag: dev-cu13
                      x86_tag: dev-x86-cu13
                      arm64_tag: dev-arm64-cu13
        steps:
            - uses: docker/setup-buildx-action@v3

            - uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}
            - run: |
                  SUFFIX="${{ inputs.tag_suffix }}"
                  TAG=${{ matrix.variant.tag }}
                  X86_TAG=${{ matrix.variant.x86_tag }}
                  ARM64_TAG=${{ matrix.variant.arm64_tag }}
                  if [ -n "$SUFFIX" ]; then
                    TAG="${TAG}-${SUFFIX}"
                    X86_TAG="${X86_TAG}-${SUFFIX}"
                    ARM64_TAG="${ARM64_TAG}-${SUFFIX}"
                  fi

                  docker buildx imagetools create \
                    -t lmsysorg/sglang:${TAG} \
                    -t lmsysorg/sglang:nightly-${TAG}-$(date +%Y%m%d)-${GITHUB_SHA:0:8} \
                    lmsysorg/sglang:${X86_TAG} \
                    lmsysorg/sglang:${ARM64_TAG}

            - name: Cleanup Old Nightly Builds
              run: |
                  # Get JWT token for Docker Hub API
                  TOKEN=$(curl -s -H "Content-Type: application/json" -X POST -d '{"username": "${{ secrets.DOCKERHUB_USERNAME }}", "password": "${{ secrets.DOCKERHUB_TOKEN }}"}' https://hub.docker.com/v2/users/login/ | jq -r .token)

                  # Get all tags for the repository
                  TAGS_RESPONSE=$(curl -s -H "Authorization: JWT $TOKEN" "https://hub.docker.com/v2/repositories/lmsysorg/sglang/tags/?page_size=100")

                  # Extract tags that match our pattern and sort by last_updated timestamp (most recent first)
                  TAGS=$(echo "$TAGS_RESPONSE" | jq -r '.results[] | select(.name | startswith("nightly-${{ matrix.variant.tag }}-")) | "\(.last_updated)|\(.name)"' | sort -r | cut -d'|' -f2)

                  # Count total tags and keep only the 14 most recent
                  TAG_COUNT=$(echo "$TAGS" | wc -l)
                  if [ "$TAG_COUNT" -gt 14 ]; then
                    echo "Found $TAG_COUNT nightly builds, keeping only the 14 most recent"
                    TAGS_TO_DELETE=$(echo "$TAGS" | tail -n +15)
                    echo "Tags to delete: $TAGS_TO_DELETE"

                    # Delete old tags
                    for tag in $TAGS_TO_DELETE; do
                      echo "Deleting tag: $tag"
                      curl -X DELETE \
                        -H "Authorization: JWT $TOKEN" \
                        "https://hub.docker.com/v2/repositories/lmsysorg/sglang/tags/$tag/"
                    done
                  else
                    echo "Only $TAG_COUNT nightly builds found, no cleanup needed"
                  fi

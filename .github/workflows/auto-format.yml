name: Auto Format Code

on:
  pull_request:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-format:
    if: github.event.label.name == 'format'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install pre-commit hook
        run: |
          python -m pip install pre-commit
          pre-commit install

      - name: Run Python format
        run: |
          SKIP=no-commit-to-branch pre-commit run --all-files || true

      - name: Run sgl-kernel clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-18
          find sgl-kernel -type f \( -name "*.h" -o -name "*.c" -o -name "*.cpp" -o -name "*.hpp" -o -name "*.cu" -o -name "*.cuh" -o -name "*.cc" \) -exec clang-format-18 -i --style=file {} \; || true

      - name: Git push
        id: git_push
        run: |
          git diff -p > auto_format.patch
          cat auto_format.patch
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -u
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "ðŸ¤– Auto-format code by CI"
          git push

      - name: Upload patch
        if: ${{ failure() && steps.git_push.outcome == 'failure' }}
        uses: actions/upload-artifact@v4
        with:
          name: auto_format-${{ github.sha }}.patch
          path: auto_format.patch

      - name: Add patch info to summary
        if: ${{ failure() && steps.git_push.outcome == 'failure' }}
        run: |
          echo "## ðŸ¤– Auto-format Patch Available" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The code has been formatted but couldn't be pushed (likely from a forked repo)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Download the patch file from the artifacts above and apply it locally:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'git apply auto_format-${{ github.sha }}.patch' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Add comment with patch info
        if: ${{ failure() && steps.git_push.outcome == 'failure' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT_FOR_PULL_REQUEST }}
          script: |
            const artifactUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const body = `ðŸ¤– **Auto-format completed!**

The code has been formatted but couldn't be pushed automatically (this PR is from a forked repo).

ðŸ“¦ Please download the patch file from [GitHub Actions Artifacts](${artifactUrl}) and apply it locally:

\`\`\`bash
git apply auto_format-${{ github.sha }}.patch
\`\`\``;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
        continue-on-error: true

      - name: Add success comment
        if: ${{ success() }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT_FOR_PULL_REQUEST }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ¤– Code has been auto-formatted and pushed successfully!'
            })
        continue-on-error: true

      - name: Remove format label
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'format'
              });
            } catch (error) {
              console.log('Label may have already been removed');
            }

name: Auto Format Code

on:
  pull_request:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-format:
    if: github.event.label.name == 'format'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install pre-commit hook
        run: |
          python -m pip install pre-commit
          pre-commit install

      - name: Run Python format
        run: |
          SKIP=no-commit-to-branch pre-commit run --all-files

      - name: Run sgl-kernel clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-18
          find sgl-kernel -type f \( -name "*.h" -o -name "*.c" -o -name "*.cpp" -o -name "*.hpp" -o -name "*.cu" -o -name "*.cuh" -o -name "*.cc" \) -exec clang-format-18 -i --style=file {} \;

      - name: Git push
        id: git_push
        run: |
          git diff -p > auto_format.patch
          cat auto_format.patch
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -u
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "ðŸ¤– Auto-format code by CI"
          git push

      - name: Upload patch
        if: ${{ failure() && steps.git_push.outcome == 'failure' }}
        uses: actions/upload-artifact@v4
        with:
          name: auto_format-${{ github.sha }}.patch
          path: auto_format.patch

      - name: Add comment
        if: ${{ failure() && steps.git_push.outcome == 'failure' }}
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ¤– Code got formatted by CI. If the PR is from a forked repo, please download the patch files from the GitHub Actions web page and apply them locally.'
            })

      - name: Remove format label
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'format'
              });
            } catch (error) {
              console.log('Label may have already been removed');
            }

From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: SGLang AMD Team <sglang@amd.com>
Date: Mon, 5 Jan 2026 00:00:00 +0000
Subject: [PATCH] fix: Use FNUZ FP8 types for gfx942 (MI300X)

MI300X (gfx942) uses FNUZ FP8 format, not OCP format:
- HIP_FP8_TYPE_FNUZ=1, HIP_FP8_TYPE_OCP=0 on gfx942
- OCP FP8 types have __host__-only default constructors on gfx942
- FNUZ FP8 types have __host__ __device__ default constructors

This patch changes the FP8 type aliases to use FNUZ types which have
device-compatible default constructors on MI300X.

Fixes compilation errors like:
  error: no matching constructor for initialization of 'vec_t<__hip_fp8_e4m3, 4UL>'
  candidate constructor (the implicit default constructor) not viable:
    call to __host__ function from __device__ function

Tested on AMD MI300X:
- RMSNorm: ✓ works
- fused_add_rmsnorm: ✓ works  
- Numerical correctness: ✓ verified

---
 include/flashinfer/vec_dtypes.cuh              | 12 ++++++------
 include/flashinfer/trtllm/common/cudaFp8Utils.h | 12 ++++++------
 2 files changed, 12 insertions(+), 12 deletions(-)

diff --git a/include/flashinfer/vec_dtypes.cuh b/include/flashinfer/vec_dtypes.cuh
index 1234567..abcdefg 100644
--- a/include/flashinfer/vec_dtypes.cuh
+++ b/include/flashinfer/vec_dtypes.cuh
@@ -25,12 +25,12 @@
 #if __has_include(<hip/hip_fp8.h>)
 #include <hip/hip_fp8.h>
-// FP8 type aliases at global namespace (CUDA-compatible names)
-using __nv_fp8_e4m3 = __hip_fp8_e4m3;
-using __nv_fp8_e5m2 = __hip_fp8_e5m2;
-using __nv_fp8x2_e4m3 = __hip_fp8x2_e4m3;
-using __nv_fp8x2_e5m2 = __hip_fp8x2_e5m2;
-using __nv_fp8x4_e4m3 = __hip_fp8x4_e4m3;
-using __nv_fp8x4_e5m2 = __hip_fp8x4_e5m2;
+// FP8 type aliases at global namespace (CUDA-compatible names)
+// Use FNUZ types for gfx942 (MI300X) - OCP types have host-only ctors
+using __nv_fp8_e4m3 = __hip_fp8_e4m3_fnuz;
+using __nv_fp8_e5m2 = __hip_fp8_e5m2_fnuz;
+using __nv_fp8x2_e4m3 = __hip_fp8x2_e4m3_fnuz;
+using __nv_fp8x2_e5m2 = __hip_fp8x2_e5m2_fnuz;
+using __nv_fp8x4_e4m3 = __hip_fp8x4_e4m3_fnuz;
+using __nv_fp8x4_e5m2 = __hip_fp8x4_e5m2_fnuz;
 using __nv_fp8_storage_t = __hip_fp8_storage_t;
 using __nv_fp8x2_storage_t = __hip_fp8x2_storage_t;
 using __nv_fp8x4_storage_t = __hip_fp8x4_storage_t;

diff --git a/include/flashinfer/trtllm/common/cudaFp8Utils.h b/include/flashinfer/trtllm/common/cudaFp8Utils.h
index 1234567..abcdefg 100644
--- a/include/flashinfer/trtllm/common/cudaFp8Utils.h
+++ b/include/flashinfer/trtllm/common/cudaFp8Utils.h
@@ -31,12 +31,12 @@
 // CUDA to HIP type alias
 using cudaStream_t = hipStream_t;
-// FP8 type aliases - use native HIP FP8 types
-using __nv_fp8_e4m3 = __hip_fp8_e4m3;
-using __nv_fp8_e5m2 = __hip_fp8_e5m2;
-using __nv_fp8x2_e4m3 = __hip_fp8x2_e4m3;
-using __nv_fp8x2_e5m2 = __hip_fp8x2_e5m2;
-using __nv_fp8x4_e4m3 = __hip_fp8x4_e4m3;
-using __nv_fp8x4_e5m2 = __hip_fp8x4_e5m2;
+// FP8 type aliases - use FNUZ types for gfx942 (MI300X)
+// OCP types have host-only default constructors on gfx942
+using __nv_fp8_e4m3 = __hip_fp8_e4m3_fnuz;
+using __nv_fp8_e5m2 = __hip_fp8_e5m2_fnuz;
+using __nv_fp8x2_e4m3 = __hip_fp8x2_e4m3_fnuz;
+using __nv_fp8x2_e5m2 = __hip_fp8x2_e5m2_fnuz;
+using __nv_fp8x4_e4m3 = __hip_fp8x4_e4m3_fnuz;
+using __nv_fp8x4_e5m2 = __hip_fp8x4_e5m2_fnuz;
 #else
 #include <cuda_fp8.h>
 #include <cuda_runtime.h>
-- 
2.39.0

